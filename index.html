<!DOCTYPE html>
<html lang="en">
<head>

  <!--
  ════════════════════════════════════════════════════════════
    PLANERA — Multi-Store Task Management App
    Version: 2.0  |  Firebase Live Sync
  ════════════════════════════════════════════════════════════

  HOW THIS FILE IS ORGANIZED:
  ─────────────────────────────
  1.  HEAD          → page settings, fonts, Firebase links
  2.  CSS STYLES    → all visual styling (colors, sizes, layout)
  3.  HTML BODY     → all the screens and buttons you see
  4.  JAVASCRIPT    → all the logic that makes the app work

  QUICK REFERENCE — Things you'll commonly want to change:
  ─────────────────────────────────────────────────────────
  • App colors       → search for "APP COLORS" below
  • Store names      → search for "STORE NAMES"
  • Default PINs     → search for "DEFAULT USERS"
  • Demo tasks       → search for "SEED TASKS"
  • Firebase config  → search for "FIREBASE CONFIG"
  ════════════════════════════════════════════════════════════
  -->

  <meta charset="UTF-8">

  <!-- Makes the app look right on mobile phones -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Allows "Add to Home Screen" on Android and iPhone -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- The color of the browser bar on Android -->
  <meta name="theme-color" content="#1a1a2e">

  <title>Planera</title>

  <!-- Google Fonts — the two fonts used in the app -->
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fraunces:wght@700;900&display=swap"
    rel="stylesheet"
  >

<style>
/* ════════════════════════════════════════════════════════════
   APP COLORS
   These are the named colors used throughout the app.
   Change a value here and it updates everywhere automatically.

   Example: to change the main red/coral color, edit --coral below.
   ════════════════════════════════════════════════════════════ */
:root {
  --coral  : #FF6B6B;  /* Main accent color — used for buttons, highlights */
  --yellow : #FFD93D;  /* Yellow — used on pop tasks                        */
  --mint   : #6BCB77;  /* Green — used for completed tasks                  */
  --sky    : #4D96FF;  /* Blue — used for links and selected states         */
  --lav    : #C77DFF;  /* Purple — used for recurrence labels               */
  --peach  : #FFB347;  /* Orange — used in button gradients                 */
  --dark   : #1a1a2e;  /* Near-black — used for nav bar and backgrounds     */
  --bg     : #F4F3FF;  /* Light lavender — main page background             */
  --card   : #FFFFFF;  /* White — task cards and panels                     */
  --muted  : #8b8fa8;  /* Gray — used for secondary text                   */
  --border : #E8E4F5;  /* Light purple-gray — borders and dividers          */
  --nav    : 64px;     /* Height of the bottom navigation bar               */
  --jj     : #D4371C;  /* Jimmy John's brand red                            */
  --rz     : #006341;  /* Runza brand green                                 */
}


/* ════════════════════════════════════════════════════════════
   GLOBAL RESET
   Removes default browser padding/margins from everything.
   You generally don't need to touch this.
   ════════════════════════════════════════════════════════════ */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent; /* removes blue flash on tap in Android */
}

html, body {
  height: 100%;
  overflow: hidden;
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--dark);
  -webkit-font-smoothing: antialiased;
}

/* The main app wrapper — stacks topbar, pages, and nav vertically */
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh; /* dvh = accounts for mobile browser chrome */
}


/* ════════════════════════════════════════════════════════════
   LOADING SCREEN
   Shown while the app connects to Firebase on startup.
   ════════════════════════════════════════════════════════════ */
#loading-screen {
  position: fixed;
  inset: 0;
  background: var(--dark);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
}
.loading-logo {
  width: 72px;
  height: 72px;
  border-radius: 22px;
  background: linear-gradient(135deg, var(--coral), var(--lav));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Fraunces', serif;
  font-size: 32px;
  font-weight: 900;
  color: white;
}
.loading-title {
  font-family: 'Fraunces', serif;
  font-size: 26px;
  font-weight: 900;
  color: white;
}
.loading-sub {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  font-weight: 600;
}
/* The spinning circle animation */
.loading-spinner {
  width: 28px;
  height: 28px;
  border: 3px solid rgba(255, 255, 255, 0.15);
  border-top-color: var(--coral);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}


/* ════════════════════════════════════════════════════════════
   LOGIN SCREEN
   Shown after loading. Hidden once user signs in.
   ════════════════════════════════════════════════════════════ */
#login-screen {
  position: fixed;
  inset: 0;
  background: var(--dark);
  z-index: 998;
  display: none;            /* hidden by default */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 28px 24px;
  gap: 14px;
  overflow-y: auto;
}
#login-screen.visible {
  display: flex;            /* shown when .visible class is added */
}

/* Logo box on login screen */
.login-logo {
  width: 68px;
  height: 68px;
  border-radius: 20px;
  background: linear-gradient(135deg, var(--coral), var(--lav));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Fraunces', serif;
  font-size: 30px;
  font-weight: 900;
  color: white;
  overflow: hidden;
  flex-shrink: 0;
}
.login-logo img { width: 100%; height: 100%; object-fit: cover; }

.login-title {
  font-family: 'Fraunces', serif;
  font-size: 27px;
  font-weight: 900;
  color: white;
}
.login-sub {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.45);
  font-weight: 600;
  margin-top: -6px;
}

/* List of user profile buttons */
.login-users {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 7px;
  max-height: 300px;
  overflow-y: auto;
}
.login-user-btn {
  width: 100%;
  background: rgba(255, 255, 255, 0.07);
  border: 1.5px solid rgba(255, 255, 255, 0.12);
  border-radius: 12px;
  padding: 11px 15px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: border-color 0.15s;
  flex-shrink: 0;
}
.login-user-btn.sel    { border-color: var(--coral); }
.login-user-btn:active { opacity: 0.75; }

.lub-av {
  width: 34px; height: 34px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 900; color: white;
  flex-shrink: 0; overflow: hidden;
}
.lub-av img   { width: 100%; height: 100%; object-fit: cover; }
.lub-info     { text-align: left; }
.lub-name     { font-size: 13px; font-weight: 800; color: white; }
.lub-role     { font-size: 10px; color: rgba(255,255,255,0.45); font-weight: 600; }

/* PIN entry field */
.login-field {
  width: 100%;
  background: rgba(255, 255, 255, 0.1);
  border: 1.5px solid rgba(255, 255, 255, 0.2);
  border-radius: 13px;
  padding: 13px 15px;
  font-family: 'Nunito', sans-serif;
  font-size: 15px;
  color: white;
  outline: none;
}
.login-field::placeholder { color: rgba(255, 255, 255, 0.3); }
.login-field:focus         { border-color: var(--coral); }

/* Sign In button */
.login-btn {
  width: 100%;
  height: 50px;
  background: linear-gradient(135deg, var(--coral), var(--peach));
  border: none;
  border-radius: 13px;
  font-family: 'Nunito', sans-serif;
  font-size: 16px;
  font-weight: 900;
  color: white;
  cursor: pointer;
}
.login-btn:active { opacity: 0.85; }

/* Error message shown on wrong PIN */
.login-err {
  font-size: 12px;
  color: var(--coral);
  font-weight: 700;
  min-height: 16px;
  text-align: center;
}


/* ════════════════════════════════════════════════════════════
   TOP BAR
   The dark bar at the very top with avatar and store pills.
   ════════════════════════════════════════════════════════════ */
.topbar {
  background: var(--dark);
  padding: 11px 15px;
  padding-top: max(11px, env(safe-area-inset-top)); /* respects iPhone notch */
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.topbar-left {
  display: flex;
  align-items: center;
  gap: 9px;
}

/* Small avatar square in top-left */
.t-av {
  width: 33px; height: 33px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--coral), var(--lav));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 900; color: white;
  flex-shrink: 0; overflow: hidden;
}
.t-av img { width: 100%; height: 100%; object-fit: cover; }

.t-name {
  font-family: 'Fraunces', serif;
  font-size: 19px;
  font-weight: 900;
  color: white;
}

/* Tiny colored dot showing Firebase sync status:
   Green = connected, Yellow = syncing, Red = offline */
.sync-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--mint);
  margin-left: 4px;
  flex-shrink: 0;
  transition: background 0.3s;
}
.sync-dot.syncing { background: var(--yellow); animation: pulse 0.8s ease-in-out infinite; }
.sync-dot.offline { background: var(--coral); }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

/* JJ / Runza filter pills — admin only */
.store-pills { display: flex; gap: 4px; }
.spill {
  font-size: 9px; font-weight: 900;
  padding: 4px 9px;
  border-radius: 20px;
  border: 1.5px solid rgba(255, 255, 255, 0.18);
  color: rgba(255, 255, 255, 0.4);
  cursor: pointer;
  transition: all 0.18s;
  letter-spacing: 0.3px;
  user-select: none;
}
.spill.on-jj { color: #ff8a6e; border-color: #ff8a6e; background: rgba(212,55,28,0.18); }
.spill.on-rz { color: #4dd88a; border-color: #4dd88a; background: rgba(0,99,65,0.18); }


/* ════════════════════════════════════════════════════════════
   PAGES (Today, Calendar, Pop, List, Settings)
   Each page sits on top of each other — only the active one shows.
   ════════════════════════════════════════════════════════════ */
.pages {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.page {
  display: none;            /* hidden by default */
  position: absolute;
  inset: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  padding: 14px 14px calc(var(--nav) + 80px); /* bottom padding so content doesn't hide behind nav */
}
.page.active {
  display: block;           /* shown when .active class is added */
}


/* ════════════════════════════════════════════════════════════
   BOTTOM NAVIGATION BAR
   ════════════════════════════════════════════════════════════ */
.bnav {
  height: var(--nav);
  background: var(--dark);
  display: flex;
  flex-shrink: 0;
  padding-bottom: env(safe-area-inset-bottom); /* respects iPhone home bar */
  position: relative; /* needed so the FAB can position itself relative to this */
}

/* Each individual tab button */
.btab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  position: relative;
  padding: 6px 2px;
}
.btab-icon { font-size: 19px; opacity: 0.32; line-height: 1; transition: opacity 0.2s; }
.btab-lbl  { font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.32); transition: color 0.2s; letter-spacing: 0.3px; }

/* Active tab — icon and label become full brightness */
.btab.on .btab-icon { opacity: 1; }
.btab.on .btab-lbl  { color: white; }

/* Notification badge (the red number bubble on tabs) */
.btab-bdg {
  position: absolute;
  top: 4px;
  right: calc(50% - 18px);
  background: var(--coral);
  color: white;
  font-size: 9px; font-weight: 900;
  min-width: 16px; height: 16px;
  padding: 0 4px;
  border-radius: 20px;
  display: none; /* hidden until .vis is added */
  align-items: center; justify-content: center;
  border: 2px solid var(--dark);
}
.btab-bdg.vis { display: flex; }


/* ════════════════════════════════════════════════════════════
   FAB (Floating Action Button) — the + button
   Lives inside .bnav so it always stays above the nav bar.
   ════════════════════════════════════════════════════════════ */
.fab {
  position: absolute;
  bottom: calc(100% + 12px); /* 12px above the top of the nav bar */
  right: 14px;
  width: 54px; height: 54px;
  background: linear-gradient(135deg, var(--coral), var(--peach));
  border: none;
  border-radius: 16px;
  color: white;
  font-size: 28px; font-weight: 900;
  line-height: 54px;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(255, 107, 107, 0.55);
  padding: 0;
  z-index: 50;
}
.fab:active { opacity: 0.82; transform: scale(0.92); }


/* ════════════════════════════════════════════════════════════
   STORE BANNER
   The colored banner at top of Today page showing which store.
   ════════════════════════════════════════════════════════════ */
.store-banner {
  border-radius: 13px;
  padding: 11px 15px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}
/* Each store gets its own gradient color */
.store-banner.jj   { background: linear-gradient(135deg, #D4371C, #ff6b3d); } /* JJ red   */
.store-banner.rz   { background: linear-gradient(135deg, #006341, #00a368); } /* Runza green */
.store-banner.both { background: linear-gradient(135deg, #2a2a4a, #3d3d6e); } /* Both = dark purple */
.sb-text { color: white; }
.sb-name { font-size: 14px; font-weight: 900; }
.sb-sub  { font-size: 11px; opacity: 0.72; }


/* ════════════════════════════════════════════════════════════
   SECTION LABELS
   The small uppercase gray labels like "DUE TODAY", "OVERDUE"
   ════════════════════════════════════════════════════════════ */
.slbl {
  font-size: 11px;
  font-weight: 900;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--muted);
  margin: 16px 0 8px;
}


/* ════════════════════════════════════════════════════════════
   TASK CARD
   The white card that represents each task.
   ════════════════════════════════════════════════════════════ */
.tcard {
  background: var(--card);
  border-radius: 13px;
  padding: 11px 12px 11px 0;
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
  border: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}
.tcard:active            { opacity: 0.76; }
.tcard.done .ttitle      { text-decoration: line-through; opacity: 0.48; } /* strikethrough when done */

/* Colored left bar on the task card */
.tbar {
  width: 4px;
  align-self: stretch;
  flex-shrink: 0;
  margin-right: 10px;
  border-radius: 4px 0 0 4px;
}

/* The circle checkbox on the left of each task */
.tchk-wrap {
  width: 44px; height: 44px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.tchk {
  width: 24px; height: 24px;
  border: 2.5px solid var(--border);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: white;
}
.tchk.on { background: var(--mint); border-color: var(--mint); } /* green when checked */

/* Task text area */
.tbody  { flex: 1; min-width: 0; padding-right: 8px; }
.ttitle { font-size: 14px; font-weight: 700; line-height: 1.35; word-break: break-word; }
.tmeta  { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; align-items: center; }
.tdt    { font-size: 11px; color: var(--muted); font-weight: 600; }   /* date label    */
.trec   { font-size: 10px; color: var(--lav);   font-weight: 800; }   /* repeat label  */

/* Store badges on task cards (JJ, RZ, Both) */
.tstore-tag  { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 10px; }
.tstore-jj   { background: #fff1ee; color: var(--jj); }
.tstore-rz   { background: #e8f5f0; color: var(--rz); }
.tboth-tag   { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 10px; background: #f0edff; color: var(--lav); }


/* ════════════════════════════════════════════════════════════
   EMPTY STATE
   Shown when a section has no tasks.
   ════════════════════════════════════════════════════════════ */
.empty {
  background: var(--card);
  border-radius: 13px;
  padding: 24px 14px;
  text-align: center;
  border: 1px dashed var(--border);
  margin-bottom: 8px;
}
.empty-e { font-size: 30px; }
.empty-t { font-size: 13px; color: var(--muted); font-weight: 700; margin-top: 5px; }


/* ════════════════════════════════════════════════════════════
   LIST PAGE — collapsible sections
   ════════════════════════════════════════════════════════════ */
.list-sec-hdr {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 8px;
  border: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}
.list-sec-title { font-size: 13px; font-weight: 900; display: flex; align-items: center; gap: 7px; }
.list-sec-count { font-size: 10px; font-weight: 800; background: var(--bg); padding: 2px 7px; border-radius: 20px; color: var(--muted); }
.list-sec-arrow { font-size: 12px; color: var(--muted); transition: transform 0.22s; }
.list-sec-arrow.open { transform: rotate(180deg); }
.list-sec-body      { overflow: hidden; max-height: 0;       transition: max-height 0.3s ease; }
.list-sec-body.open { max-height: 5000px; } /* large enough to show all tasks */


/* ════════════════════════════════════════════════════════════
   COLLAPSE (Completed section on Today page)
   ════════════════════════════════════════════════════════════ */
.collapse-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin: 16px 0 8px;
  cursor: pointer;
  user-select: none;
}
.collapse-hdr .slbl { margin: 0; }
.collapse-arrow      { font-size: 13px; color: var(--muted); transition: transform 0.22s; flex-shrink: 0; }
.collapse-arrow.open { transform: rotate(180deg); }
.collapse-body       { overflow: hidden; transition: max-height 0.3s ease; max-height: 0; }
.collapse-body.open  { max-height: 3000px; }


/* ════════════════════════════════════════════════════════════
   CALENDAR PAGE
   ════════════════════════════════════════════════════════════ */
.cal-nav   { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.cal-nbtn  { width: 40px; height: 40px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.cal-nbtn:active { background: var(--border); }
.cal-mlbl  { font-family: 'Fraunces', serif; font-size: 19px; font-weight: 900; } /* Month + Year label */
.cal-wrap  { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 12px; }
.cal-hrow  { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--dark); }
.cal-h     { text-align: center; padding: 8px 0; font-size: 10px; font-weight: 800; color: rgba(255,255,255,0.45); }
.cal-cells { display: grid; grid-template-columns: repeat(7, 1fr); }

/* Individual calendar day cell */
.cal-cell         { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); min-height: 50px; padding: 4px 3px; cursor: pointer; user-select: none; }
.cal-cell:active  { background: #f0edff; }
.cal-cell.oth     { opacity: 0.22; pointer-events: none; } /* days from other months */
.cal-cell.tod     { background: #fff8f0; }                 /* today */
.cal-cell.sel     { background: #eff4ff; box-shadow: inset 0 0 0 2px var(--sky); } /* selected day */

.cal-dn             { font-size: 11px; font-weight: 800; color: var(--muted); width: 21px; height: 21px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.cal-cell.tod .cal-dn { background: var(--coral); color: white; } /* today's number has red circle */

/* Colored dots on calendar cells showing tasks that day */
.cal-dots { display: flex; gap: 2px; flex-wrap: wrap; margin-top: 2px; }
.cal-dot  { width: 5px; height: 5px; border-radius: 50%; }

/* The task list panel that shows when you tap a day */
.day-panel      { background: var(--card); border-radius: 13px; border: 1px solid var(--border); padding: 13px; margin-bottom: 12px; }
.day-panel-ttl  { font-size: 14px; font-weight: 900; margin-bottom: 10px; }

/* Pop tasks section at bottom of calendar */
.cal-pop-sec  { background: linear-gradient(135deg, #fff9e6, #fff0f0); border-radius: 13px; border: 1px solid #fde68a; padding: 13px; }
.cal-pop-ttl  { font-size: 13px; font-weight: 900; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.pop-mini     { display: flex; align-items: center; gap: 8px; padding: 9px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
.pop-mini:last-child { border-bottom: none; }
.pop-mini-t   { flex: 1; font-size: 13px; font-weight: 700; }
.asn-btn      { font-size: 11px; font-weight: 800; color: var(--sky); background: #eff6ff; border: none; border-radius: 8px; padding: 7px 10px; cursor: pointer; }
.asn-btn:active { opacity: 0.7; }


/* ════════════════════════════════════════════════════════════
   POP TASKS PAGE
   ════════════════════════════════════════════════════════════ */
.pop-hero {
  background: linear-gradient(135deg, var(--yellow) 0%, var(--coral) 60%, var(--lav) 100%);
  border-radius: 17px;
  padding: 18px;
  color: white;
  margin-bottom: 14px;
}
.pop-hero h2 { font-family: 'Fraunces', serif; font-size: 21px; font-weight: 900; margin-bottom: 3px; }
.pop-hero p  { font-size: 12px; opacity: 0.85; }

/* Individual pop task card */
.pop-card { background: var(--card); border-radius: 13px; border: 1px solid var(--border); margin-bottom: 8px; overflow: hidden; }
.pctop    { height: 4px; }  /* colored top stripe */
.pcbody   { padding: 11px 13px; }
.pctitle  { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
.pctime   { font-size: 11px; color: var(--muted); font-weight: 600; }
.pcacts   { display: flex; gap: 6px; margin-top: 9px; }
.pact     { flex: 1; height: 37px; border: none; border-radius: 9px; font-family: 'Nunito', sans-serif; font-size: 11px; font-weight: 800; cursor: pointer; }
.pact:active { opacity: 0.7; }
.pa-sched { background: #eff6ff; color: var(--sky); }    /* Schedule button */
.pa-done  { background: #f0fdf4; color: #16a34a; }       /* Done button     */
.pa-del   { background: #fff1f1; color: var(--coral); }  /* Delete button   */


/* ════════════════════════════════════════════════════════════
   SETTINGS PAGE
   ════════════════════════════════════════════════════════════ */
.settings-section { background: var(--card); border-radius: 15px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; }
.settings-hdr     { padding: 13px 15px 5px; font-size: 11px; font-weight: 900; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted); }
.setting-row               { display: flex; align-items: center; justify-content: space-between; padding: 13px 15px; border-top: 1px solid var(--border); }
.setting-row:first-of-type { border-top: none; }
.setting-label { font-size: 14px; font-weight: 700; }
.setting-sub   { font-size: 11px; color: var(--muted); font-weight: 600; margin-top: 2px; }

/* Toggle switch (the on/off slider) */
.toggle {
  width: 44px; height: 26px;
  background: var(--border);
  border-radius: 13px;
  position: relative;
  cursor: pointer;
  transition: background 0.22s;
  flex-shrink: 0;
}
.toggle.on { background: var(--mint); }
.toggle::after {
  content: '';
  position: absolute;
  top: 3px; left: 3px;
  width: 20px; height: 20px;
  background: white;
  border-radius: 50%;
  transition: transform 0.22s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.18);
}
.toggle.on::after { transform: translateX(18px); }

.app-version { text-align: center; font-size: 11px; color: var(--muted); font-weight: 600; margin-top: 4px; padding-bottom: 8px; }

/* Accent color dot pickers */
.accent-opts { display: flex; gap: 9px; flex-wrap: wrap; }
.accent-dot  { width: 27px; height: 27px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: transform 0.15s; }
.accent-dot.sel { border-color: var(--dark); transform: scale(1.14); }
.accent-dot:active { transform: scale(0.88); }

/* Profile photo area */
.profile-pic-row     { display: flex; align-items: center; gap: 13px; }
.profile-pic-preview { width: 50px; height: 50px; border-radius: 13px; background: linear-gradient(135deg, var(--coral), var(--lav)); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; color: white; flex-shrink: 0; overflow: hidden; cursor: pointer; border: 2px solid var(--border); }
.profile-pic-preview img { width: 100%; height: 100%; object-fit: cover; }
.profile-pic-btn     { font-size: 12px; font-weight: 800; color: var(--sky); cursor: pointer; }

/* Team member rows */
.user-row           { display: flex; align-items: center; gap: 11px; padding: 12px 15px; border-top: 1px solid var(--border); cursor: pointer; }
.user-row:first-child { border-top: none; }
.user-row:active    { background: #f8f7ff; }
.user-av            { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; color: white; flex-shrink: 0; overflow: hidden; }
.user-av img        { width: 100%; height: 100%; object-fit: cover; }
.user-info          { flex: 1; }
.user-name          { font-size: 13px; font-weight: 800; }
.user-meta          { font-size: 11px; color: var(--muted); font-weight: 600; }
.user-store-tag     { font-size: 9px; font-weight: 900; padding: 2px 7px; border-radius: 20px; }
.user-edit-hint     { font-size: 14px; color: var(--muted); opacity: 0.5; }

/* Share section */
.share-card     { background: var(--bg); border-radius: 12px; padding: 13px; margin-bottom: 9px; }
.share-link-box { font-size: 12px; font-weight: 800; color: var(--sky); word-break: break-all; background: #eff6ff; border-radius: 8px; padding: 9px; margin-top: 7px; display: block; line-height: 1.5; }
.share-copy-btn { width: 100%; height: 43px; background: var(--sky); color: white; border: none; border-radius: 11px; font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 800; cursor: pointer; margin-top: 7px; }
.share-copy-btn:active { opacity: 0.78; }


/* ════════════════════════════════════════════════════════════
   BOTTOM SHEETS (slide-up modals)
   Used for Add Task, Edit Task, Pop Add, Edit User, Share
   ════════════════════════════════════════════════════════════ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.52);
  z-index: 200;
  align-items: flex-end;
  backdrop-filter: blur(3px);
}
.overlay.open { display: flex; }

.sheet {
  background: var(--card);
  border-radius: 22px 22px 0 0;
  width: 100%;
  max-height: 92dvh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 17px calc(20px + env(safe-area-inset-bottom));
  animation: sUp 0.27s cubic-bezier(0.22, 1, 0.36, 1);
}
@keyframes sUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* The little drag handle at the top of each sheet */
.s-handle { width: 38px; height: 4px; background: var(--border); border-radius: 4px; margin: 11px auto 16px; }
.s-title  { font-family: 'Fraunces', serif; font-size: 21px; font-weight: 900; margin-bottom: 16px; }

/* Form fields inside sheets */
.fg   { margin-bottom: 13px; }
.flbl { font-size: 10px; font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; display: block; }
.fctrl {
  width: 100%;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 11px;
  padding: 11px 13px;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  color: var(--dark);
  outline: none;
  -webkit-appearance: none;
}
.fctrl:focus { border-color: var(--sky); }

/* Option pill buttons (used for color, recurrence, workspace) */
.opts { display: flex; gap: 6px; flex-wrap: wrap; }
.oc   { padding: 7px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: white; font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 800; cursor: pointer; color: var(--dark); }
.oc:active  { transform: scale(0.93); }
.oc.s-coral { border-color: var(--coral); background: #fff1f1; color: var(--coral); } /* selected workspace */
.oc.s-sky   { border-color: var(--sky);   background: #eff6ff; color: var(--sky);   } /* selected option   */
.oc.s-none  { border-color: var(--muted); background: #f3f4f6; color: var(--dark);  } /* "None" selected   */

/* Color swatches */
.swatches { display: flex; gap: 9px; flex-wrap: wrap; }
.swatch   { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; }
.swatch:active { transform: scale(0.87); }
.swatch.sel    { border-color: var(--dark); transform: scale(1.12); }

/* Sheet action buttons row */
.s-acts   { display: flex; gap: 9px; margin-top: 18px; }
.btn-save { flex: 1; height: 50px; background: linear-gradient(135deg, var(--coral), var(--peach)); color: white; border: none; border-radius: 13px; font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 900; cursor: pointer; }
.btn-save:active { opacity: 0.82; }
.btn-cnl  { height: 50px; padding: 0 18px; background: var(--bg); border: none; border-radius: 13px; font-family: 'Nunito', sans-serif; font-size: 14px; font-weight: 700; color: var(--muted); cursor: pointer; }
.btn-cnl:active { opacity: 0.75; }
.btn-del-task { width: 100%; height: 43px; background: #fff1f1; border: none; border-radius: 11px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 800; color: var(--coral); cursor: pointer; margin-top: 5px; }
.btn-del-task:active { opacity: 0.75; }

/* Recurrence sub-sections */
.rec-sub      { display: none; background: var(--bg); border-radius: 11px; padding: 11px; margin-top: 7px; }
.rec-sub.show { display: block; }

/* Day-of-week buttons (Su Mo Tu...) */
.day-btns { display: flex; gap: 5px; flex-wrap: wrap; }
.day-btn  { width: 37px; height: 37px; border-radius: 50%; border: 1.5px solid var(--border); background: white; font-family: 'Nunito', sans-serif; font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--dark); }
.day-btn.on    { background: var(--sky); border-color: var(--sky); color: white; }
.day-btn:active { transform: scale(0.9); }

/* Rich text notes editor */
.notes-toolbar { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
.ntb { width: 32px; height: 32px; border: 1.5px solid var(--border); border-radius: 8px; background: white; font-size: 13px; font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--dark); font-family: 'Nunito', sans-serif; }
.ntb:active { background: var(--bg); }
.ntb.wide { width: auto; padding: 0 10px; font-size: 11px; }
.notes-editor {
  width: 100%;
  min-height: 90px;
  max-height: 200px;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 11px;
  padding: 11px 13px;
  font-family: 'Nunito', sans-serif;
  font-size: 14px;
  color: var(--dark);
  outline: none;
  overflow-y: auto;
  line-height: 1.6;
}
.notes-editor:focus { border-color: var(--sky); }
.notes-editor ul, .notes-editor ol { padding-left: 20px; }


/* ════════════════════════════════════════════════════════════
   TOAST NOTIFICATION
   The small message that pops up briefly (e.g. "Task saved!")
   ════════════════════════════════════════════════════════════ */
.toast {
  position: fixed;
  bottom: calc(var(--nav) + 80px);
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: var(--dark);
  color: white;
  padding: 9px 18px;
  border-radius: 40px;
  font-size: 13px; font-weight: 800;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.22s, transform 0.22s;
  z-index: 400;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Updated fix for desktop stretching - scales with monitor size */
@media (min-width: 768px) {  /* For tablets/small desktops */
  body {
    display: flex;
    justify-content: center;
    align-items: flex-start;  /* Align to top for better flow */
    background: var(--bg);
    overflow: auto;
    padding: 20px;  /* Adds space around the app on big screens */
  }
  .app {
    max-width: 500px;  /* Medium size for small desktops */
    width: 100%;  /* Fills available space up to max */
    min-height: 100vh;  /* Fills full height dynamically */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 20px;
    overflow: hidden;
  }
  .overlay.open {
    align-items: center;
  }
  .sheet {
    max-height: 90%;
  }
}

@media (min-width: 1440px) {  /* For 1440p monitors */
  .app {
    max-width: 700px;  /* Wider for mid-size monitors */
  }
}

@media (min-width: 1920px) {  /* For 1080p/27-inch or larger */
  .app {
    max-width: calc(45vw);  /* Scales to ~45% of screen width for balance */
    max-width: min(1920px, 45vw);  /* Caps at 900px to avoid too wide */
  }
  body {
    padding: 40px;  /* More space on huge screens */
  }
}
  
</style>
</head>


<!-- ════════════════════════════════════════════════════════════
     HTML BODY — All the visible screens and elements
     ════════════════════════════════════════════════════════════ -->
<body>


<!-- ──────────────────────────────────────────────────────────
     LOADING SCREEN
     Shows while Firebase connects. Replaced by login screen.
     ────────────────────────────────────────────────────────── -->
<div id="loading-screen">
  <div class="loading-logo">P</div>
  <div class="loading-title">Planera</div>
  <div class="loading-sub" id="loading-sub">Connecting to Firebase...</div>
  <div class="loading-spinner"></div>
</div>


<!-- ──────────────────────────────────────────────────────────
     LOGIN SCREEN
     Users pick their profile and enter their PIN here.
     ────────────────────────────────────────────────────────── -->
<div id="login-screen">
  <div class="login-logo" id="login-logo">P</div>
  <div class="login-title">Planera</div>
  <div class="login-sub">Select your profile to sign in</div>

  <!-- User profile buttons — built dynamically by JavaScript -->
  <div class="login-users" id="login-users"></div>

  <!-- PIN entry -->
  <input
    class="login-field"
    id="login-pin"
    type="password"
    inputmode="numeric"
    maxlength="4"
    placeholder="Enter your 4-digit PIN"
  >
  <div class="login-err" id="login-err"></div>
  <button class="login-btn" id="login-btn">Sign In</button>
</div>


<!-- ──────────────────────────────────────────────────────────
     MAIN APP
     Hidden until login. Contains topbar, pages, and nav.
     ────────────────────────────────────────────────────────── -->
<div class="app" id="main-app" style="display:none">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="t-av" id="top-av">P</div>
      <span class="t-name">Planera</span>
      <!-- Sync status dot: green=connected, yellow=syncing, red=offline -->
      <div class="sync-dot" id="sync-dot"></div>
    </div>
    <!-- JJ / Runza filter pills — only visible to admin -->
    <div class="store-pills" id="store-pills" style="display:none"></div>
  </div>


  <!-- PAGE CONTAINER — all 5 pages live here -->
  <div class="pages">


    <!-- PAGE: CALENDAR ──────────────────────────────────── -->
    <div class="page" id="pg-calendar">

      <!-- Month navigation arrows -->
      <div class="cal-nav">
        <button class="cal-nbtn" id="cal-prev">&#8249;</button>
        <div class="cal-mlbl" id="cal-lbl"></div>
        <button class="cal-nbtn" id="cal-next">&#8250;</button>
      </div>

      <!-- Calendar grid -->
      <div class="cal-wrap">
        <div class="cal-hrow">
          <div class="cal-h">S</div><div class="cal-h">M</div><div class="cal-h">T</div>
          <div class="cal-h">W</div><div class="cal-h">T</div><div class="cal-h">F</div><div class="cal-h">S</div>
        </div>
        <div class="cal-cells" id="cal-cells"></div>
      </div>

      <!-- Tasks for selected day -->
      <div class="day-panel" id="day-panel">
        <div class="day-panel-ttl" id="dpt">Tap a day to view tasks</div>
        <div id="dpt-tasks"></div>
      </div>

      <!-- Unscheduled pop tasks at bottom of calendar -->
      <div class="cal-pop-sec">
        <div class="cal-pop-ttl">
          &#9889; Pop Tasks
          <span style="background:var(--yellow);color:var(--dark);font-size:10px;padding:2px 7px;border-radius:12px;font-weight:900">Unscheduled</span>
        </div>
        <div id="cal-pop-list"></div>
      </div>

    </div><!-- end pg-calendar -->


    <!-- PAGE: POP TASKS ─────────────────────────────────── -->
    <div class="page" id="pg-pop">

      <div class="pop-hero">
        <h2>Pop Tasks &#9889;</h2>
        <p>Quick captures. Tap + to add a new one.</p>
      </div>

      <div class="slbl">
        Your tasks <span id="pop-cnt" style="color:var(--lav)"></span>
      </div>

      <!-- Pop task cards built here by JavaScript -->
      <div id="pop-grid"></div>

    </div><!-- end pg-pop -->


    <!-- PAGE: TODAY ─────────────────────────────────────── -->
    <div class="page active" id="pg-today">

      <!-- Store banner (Jimmy John's / Runza / Both) -->
      <div id="today-store-banner"></div>

      <!-- Overdue section — hidden if no overdue tasks -->
      <div id="ov-wrap" style="display:none">
        <div class="slbl" style="color:var(--coral)">Overdue</div>
        <div id="ov-list"></div>
      </div>

      <!-- Due today -->
      <div class="slbl">Due Today</div>
      <div id="td-list"></div>

      <!-- Completed section (collapsible) -->
      <div class="collapse-hdr" id="dn-hdr">
        <div class="slbl">Completed</div>
        <div class="collapse-arrow" id="dn-arrow">&#9660;</div>
      </div>
      <div class="collapse-body" id="dn-body">
        <div id="dn-list"></div>
      </div>

    </div><!-- end pg-today -->


    <!-- PAGE: LIST ──────────────────────────────────────── -->
    <div class="page" id="pg-list">
      <!-- Collapsible sections built here by JavaScript -->
      <div id="list-sections"></div>
    </div>


    <!-- PAGE: SETTINGS ──────────────────────────────────── -->
    <div class="page" id="pg-settings">

      <!-- Your Profile -->
      <div class="settings-section">
        <div class="settings-hdr">Your Profile</div>
        <div class="setting-row">
          <div class="profile-pic-row">
            <div class="profile-pic-preview" id="settings-av" onclick="triggerAvatarUpload()">P</div>
            <div>
              <div class="setting-label" id="settings-username">Loading...</div>
              <div class="setting-sub"   id="settings-role">...</div>
              <div class="profile-pic-btn" id="change-photo-btn" style="display:none" onclick="triggerAvatarUpload()">Change photo</div>
            </div>
          </div>
        </div>
        <!-- Hidden file input for avatar upload -->
        <input type="file" id="avatar-upload" accept="image/*" style="display:none">
      </div>

      <!-- Workspaces & Sharing — admin only -->
      <div class="settings-section" id="admin-workspaces-section" style="display:none">
        <div class="settings-hdr">Workspaces &amp; Sharing</div>
        <div class="setting-row" id="share-jj-row" style="cursor:pointer">
          <div>
            <div class="setting-label" style="color:var(--jj)">Jimmy John's</div>
            <div class="setting-sub">Share invite with JJ GM</div>
          </div>
          <span style="color:var(--muted);font-size:18px">&#8250;</span>
        </div>
        <div class="setting-row" id="share-rz-row" style="cursor:pointer">
          <div>
            <div class="setting-label" style="color:var(--rz)">Runza</div>
            <div class="setting-sub">Share invite with Runza GM</div>
          </div>
          <span style="color:var(--muted);font-size:18px">&#8250;</span>
        </div>
      </div>

      <!-- Team Members — admin only -->
      <div class="settings-section" id="admin-team-section" style="display:none">
        <div class="settings-hdr">
          Team Members
          <span style="font-weight:600;letter-spacing:0;text-transform:none;font-size:10px;color:var(--sky)">(tap to edit)</span>
        </div>
        <div id="team-list"></div>
      </div>

      <!-- Appearance -->
      <div class="settings-section">
        <div class="settings-hdr">Appearance</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Accent Color</div>
            <div class="setting-sub">App highlight color</div>
          </div>
          <div class="accent-opts">
            <div class="accent-dot sel" data-color="#FF6B6B" style="background:#FF6B6B"></div>
            <div class="accent-dot"     data-color="#4D96FF" style="background:#4D96FF"></div>
            <div class="accent-dot"     data-color="#6BCB77" style="background:#6BCB77"></div>
            <div class="accent-dot"     data-color="#C77DFF" style="background:#C77DFF"></div>
            <div class="accent-dot"     data-color="#FFB347" style="background:#FFB347"></div>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="settings-section">
        <div class="settings-hdr">Notifications</div>
        <div class="setting-row">
          <div><div class="setting-label">Task Reminders</div><div class="setting-sub">Get notified before tasks are due</div></div>
          <div class="toggle on" data-tog="remind"></div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Daily Summary</div><div class="setting-sub">Morning overview of your day</div></div>
          <div class="toggle" data-tog="summary"></div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Pop Task Nudge</div><div class="setting-sub">Remind to schedule pop tasks</div></div>
          <div class="toggle on" data-tog="pop"></div>
        </div>
      </div>

      <!-- General -->
      <div class="settings-section">
        <div class="settings-hdr">General</div>
        <div class="setting-row">
          <div><div class="setting-label">Haptic Feedback</div><div class="setting-sub">Vibrate on task completion</div></div>
          <div class="toggle on" data-tog="haptic"></div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Confirm Before Deleting</div><div class="setting-sub">Show prompt before removing tasks</div></div>
          <div class="toggle on" data-tog="confirm"></div>
        </div>
      </div>

      <!-- Admin Danger Zone — admin only -->
      <div class="settings-section" id="admin-danger-section" style="display:none">
        <div class="settings-hdr">Admin</div>
        <div class="setting-row" id="clear-data-row" style="cursor:pointer">
          <div>
            <div class="setting-label" style="color:var(--coral)">Clear All Tasks</div>
            <div class="setting-sub">Permanently delete all tasks from Firebase</div>
          </div>
          <span style="color:var(--coral);font-size:18px">&#8250;</span>
        </div>
      </div>

      <!-- Sign Out -->
      <div class="setting-row" id="logout-row" style="cursor:pointer;background:var(--card);border-radius:15px;border:1px solid var(--border);margin-bottom:15px;">
        <div class="setting-label" style="color:var(--coral)">Sign Out</div>
        <span style="color:var(--coral);font-size:18px">&#8250;</span>
      </div>

      <div class="app-version">
        Planera v2.0 &bull; Firebase Live Sync &#9679; <span id="sync-status-lbl">Connected</span>
      </div>

    </div><!-- end pg-settings -->


  </div><!-- end .pages -->


  <!-- BOTTOM NAVIGATION BAR -->
  <nav class="bnav">

    <!-- + button — floats above nav bar, opens add task sheet -->
    <button class="fab" id="btn-fab">+</button>

    <!-- Nav tabs — order here = order on screen (left to right) -->
    <div class="btab" data-page="calendar" id="tab-calendar">
      <span class="btab-icon">&#128197;</span>
      <span class="btab-lbl">Calendar</span>
    </div>
    <div class="btab" data-page="pop" id="tab-pop">
      <span class="btab-icon">&#9889;</span>
      <span class="btab-lbl">Pop</span>
      <span class="btab-bdg" id="bdg-pop">0</span>
    </div>
    <div class="btab on" data-page="today" id="tab-today">
      <span class="btab-icon">&#9728;&#65039;</span>
      <span class="btab-lbl">Today</span>
      <span class="btab-bdg" id="bdg-today">0</span>
    </div>
    <div class="btab" data-page="list" id="tab-list">
      <span class="btab-icon">&#128203;</span>
      <span class="btab-lbl">List</span>
    </div>
    <div class="btab" data-page="settings" id="tab-settings">
      <span class="btab-icon">&#9881;&#65039;</span>
      <span class="btab-lbl">Settings</span>
    </div>

  </nav>

</div><!-- end #main-app -->


<!-- ──────────────────────────────────────────────────────────
     BOTTOM SHEET: ADD / EDIT TASK
     Also used when scheduling a pop task.
     ────────────────────────────────────────────────────────── -->
<div class="overlay" id="ov-add">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title" id="sheet-title">New Task</div>

    <!-- Title -->
    <div class="fg">
      <label class="flbl">Title *</label>
      <input class="fctrl" id="f-title" type="text" placeholder="What needs to be done?">
    </div>

    <!-- Notes (rich text editor with formatting toolbar) -->
    <div class="fg">
      <label class="flbl">Notes</label>
      <div class="notes-toolbar">
        <button class="ntb" onclick="noteCmd('bold')"><b>B</b></button>
        <button class="ntb" onclick="noteCmd('italic')"><i>I</i></button>
        <button class="ntb" onclick="noteCmd('underline')"><u>U</u></button>
        <button class="ntb" onclick="noteCmd('insertUnorderedList')">&#8226;</button>
        <button class="ntb" onclick="noteCmd('insertOrderedList')">1.</button>
        <button class="ntb" onclick="noteCmd('indent')">&#8677;</button>
        <button class="ntb" onclick="noteCmd('outdent')">&#8676;</button>
        <button class="ntb wide" onclick="noteCmd('removeFormat')">Clear</button>
      </div>
      <div class="notes-editor" id="f-notes" contenteditable="true"></div>
    </div>

    <!-- Due Date -->
    <div class="fg">
      <label class="flbl">Due Date</label>
      <input class="fctrl" id="f-date" type="date">
    </div>

    <!-- Workspace picker — only shown to admin -->
    <div class="fg" id="f-store-wrap" style="display:none">
      <label class="flbl">Workspace *</label>
      <div class="opts" id="store-opts">
        <div class="oc" data-v="jj">Jimmy John's</div>
        <div class="oc" data-v="rz">Runza</div>
      </div>
    </div>

    <!-- Color picker -->
    <div class="fg">
      <label class="flbl">Color</label>
      <div class="swatches" id="sw-opts">
        <div class="swatch sel" data-c="coral"    style="background:#FF6B6B"></div>
        <div class="swatch"     data-c="sky"      style="background:#4D96FF"></div>
        <div class="swatch"     data-c="mint"     style="background:#6BCB77"></div>
        <div class="swatch"     data-c="lavender" style="background:#C77DFF"></div>
        <div class="swatch"     data-c="yellow"   style="background:#FFD93D"></div>
        <div class="swatch"     data-c="peach"    style="background:#FFB347"></div>
      </div>
    </div>

    <!-- Recurrence picker -->
    <div class="fg">
      <label class="flbl">Recurrence</label>
      <div class="opts" id="rec-opts">
        <div class="oc s-none" data-v="none">None</div>
        <div class="oc"        data-v="daily">Daily</div>
        <div class="oc"        data-v="weekly">Weekly</div>
        <div class="oc"        data-v="biweekly">Bi-weekly</div>
        <div class="oc"        data-v="monthly">Monthly</div>
        <div class="oc"        data-v="yearly">Yearly</div>
      </div>

      <!-- Weekly day selector (shown when Weekly is picked) -->
      <div class="rec-sub" id="rec-weekly-sub">
        <label class="flbl">Days</label>
        <div class="day-btns" id="weekly-days">
          <div class="day-btn" data-d="0">Su</div><div class="day-btn" data-d="1">Mo</div>
          <div class="day-btn" data-d="2">Tu</div><div class="day-btn" data-d="3">We</div>
          <div class="day-btn" data-d="4">Th</div><div class="day-btn" data-d="5">Fr</div>
          <div class="day-btn" data-d="6">Sa</div>
        </div>
      </div>

      <!-- Bi-weekly day selector -->
      <div class="rec-sub" id="rec-biweekly-sub">
        <label class="flbl">Days (every other week)</label>
        <div class="day-btns" id="biweekly-days">
          <div class="day-btn" data-d="0">Su</div><div class="day-btn" data-d="1">Mo</div>
          <div class="day-btn" data-d="2">Tu</div><div class="day-btn" data-d="3">We</div>
          <div class="day-btn" data-d="4">Th</div><div class="day-btn" data-d="5">Fr</div>
          <div class="day-btn" data-d="6">Sa</div>
        </div>
      </div>

      <!-- Monthly options -->
      <div class="rec-sub" id="rec-monthly-sub">
        <label class="flbl">Repeat on</label>
        <div class="opts" id="monthly-type-opts">
          <div class="oc s-sky" data-v="date">Same date</div>
          <div class="oc"       data-v="weekday">Day of week</div>
        </div>
        <!-- Extra options when "Day of week" is chosen -->
        <div id="monthly-weekday-sub" style="display:none;margin-top:9px;">
          <label class="flbl">Which occurrence</label>
          <div class="opts" id="monthly-occ-opts">
            <div class="oc" data-v="1">1st</div><div class="oc" data-v="2">2nd</div>
            <div class="oc" data-v="3">3rd</div><div class="oc" data-v="4">4th</div>
            <div class="oc" data-v="-1">Last</div>
          </div>
          <label class="flbl" style="margin-top:9px;">Which day</label>
          <div class="day-btns" id="monthly-day-opts">
            <div class="day-btn" data-d="0">Su</div><div class="day-btn" data-d="1">Mo</div>
            <div class="day-btn" data-d="2">Tu</div><div class="day-btn" data-d="3">We</div>
            <div class="day-btn" data-d="4">Th</div><div class="day-btn" data-d="5">Fr</div>
            <div class="day-btn" data-d="6">Sa</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Save / Cancel buttons -->
    <div class="s-acts">
      <button class="btn-cnl"  id="btn-add-cancel">Cancel</button>
      <button class="btn-save" id="btn-add-save">Save Task</button>
    </div>
    <!-- Delete button — only shown when editing an existing task -->
    <button class="btn-del-task" id="btn-del-task" style="display:none">Delete Task</button>

  </div>
</div>


<!-- ──────────────────────────────────────────────────────────
     BOTTOM SHEET: POP TASK QUICK-ADD
     Simple one-field sheet for capturing quick thoughts.
     ────────────────────────────────────────────────────────── -->
<div class="overlay" id="ov-pop-add">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title">New Pop Task</div>
    <div class="fg">
      <label class="flbl">Task</label>
      <input class="fctrl" id="f-pop-title" type="text" placeholder="What's on your mind?">
    </div>
    <div class="s-acts">
      <button class="btn-cnl"  id="btn-pop-cancel">Cancel</button>
      <button class="btn-save" id="btn-pop-save">Add</button>
    </div>
  </div>
</div>


<!-- ──────────────────────────────────────────────────────────
     BOTTOM SHEET: EDIT TEAM MEMBER
     Admin can tap any user in Settings to open this.
     ────────────────────────────────────────────────────────── -->
<div class="overlay" id="ov-edit-user">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title">Edit Team Member</div>
    <div class="fg">
      <label class="flbl">Name</label>
      <input class="fctrl" id="eu-name" type="text" placeholder="Employee name">
    </div>
    <div class="fg">
      <label class="flbl">Title / Role</label>
      <input class="fctrl" id="eu-role" type="text" placeholder="e.g. General Manager">
    </div>
    <div class="fg">
      <label class="flbl">PIN (4 digits)</label>
      <input class="fctrl" id="eu-pin" type="password" inputmode="numeric" maxlength="4" placeholder="4-digit PIN">
    </div>
    <div class="fg">
      <label class="flbl">Workspace</label>
      <div class="opts" id="eu-store-opts">
        <div class="oc" data-v="jj">Jimmy John's</div>
        <div class="oc" data-v="rz">Runza</div>
        <div class="oc" data-v="both">Both</div>
      </div>
    </div>
    <div class="s-acts">
      <button class="btn-cnl"  id="btn-eu-cancel">Cancel</button>
      <button class="btn-save" id="btn-eu-save">Save</button>
    </div>
  </div>
</div>


<!-- ──────────────────────────────────────────────────────────
     BOTTOM SHEET: SHARE / INVITE
     Admin uses this to share the app link and PIN with GMs.
     ────────────────────────────────────────────────────────── -->
<div class="overlay" id="ov-share">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-title" id="share-title">Share Access</div>

    <!-- App URL row -->
    <div class="share-card">
      <div style="font-size:12px;font-weight:700;color:var(--muted)">App URL — send this to your GM</div>
      <div class="share-link-box" id="share-url-text">Loading...</div>
      <button class="share-copy-btn" id="share-copy-url-btn">Copy Link</button>
    </div>

    <!-- PIN row -->
    <div class="share-card">
      <div style="font-size:12px;font-weight:700;color:var(--muted)">GM Sign-in PIN</div>
      <div class="share-link-box" id="share-pin-text"></div>
      <button class="share-copy-btn" id="share-copy-pin-btn">Copy PIN</button>
    </div>

    <div style="font-size:11px;color:var(--muted);font-weight:600;padding:8px 0 4px;line-height:1.6">
      Send the link and PIN to your GM. They open the link, select their name, enter the PIN — live with real-time sync instantly.
    </div>

    <button class="btn-cnl" style="width:100%;height:47px;margin-top:6px;" id="btn-share-close">Done</button>
  </div>
</div>


<!-- Toast notification (the little popup message) -->
<div class="toast" id="toast"></div>


<!-- ════════════════════════════════════════════════════════════
     FIREBASE SDK IMPORTS
     These load the Firebase libraries from Google's CDN.
     Do not change these unless updating the Firebase version.
     ════════════════════════════════════════════════════════════ -->
<script type="module">

import { initializeApp } from
  'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';

import {
  getFirestore,
  collection,
  doc,
  onSnapshot,
  setDoc,
  deleteDoc,
  getDocs,
  writeBatch
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';


/* ════════════════════════════════════════════════════════════
   FIREBASE CONFIG
   These keys connect the app to YOUR Firebase project.
   Do not share these publicly.
   ════════════════════════════════════════════════════════════ */
const app = initializeApp({
  apiKey:            "AIzaSyB5pxd9e0jFkUtjPnh3XJDor-EUv2ZZCRA",
  authDomain:        "planera-f38bc.firebaseapp.com",
  projectId:         "planera-f38bc",
  storageBucket:     "planera-f38bc.firebasestorage.app",
  messagingSenderId: "656328953708",
  appId:             "1:656328953708:web:65cf6532457539805f6d49"
});
const db = getFirestore(app);


/* ════════════════════════════════════════════════════════════
   DEFAULT USERS
   These are the 5 team members loaded into Firebase on first run.

   TO CHANGE A USER:
   • name      = display name shown on login screen
   • title     = job title shown under name
   • pin       = 4-digit sign-in PIN (must be unique)
   • role      = 'admin', 'gm', or 'staff'
   • store     = 'jj', 'rz', or 'both'
   • initials  = 1-2 letters shown in avatar circle
   ════════════════════════════════════════════════════════════ */
const DEFAULT_USERS = [
  { id:'u1', name:'You (Admin)',       title:'Area Manager',     pin:'0000', role:'admin', store:'both', avatar:'', initials:'A' },
  { id:'u2', name:'JJ Manager',        title:'General Manager',  pin:'1111', role:'gm',    store:'jj',   avatar:'', initials:'J' },
  { id:'u3', name:'Runza Manager',     title:'General Manager',  pin:'2222', role:'gm',    store:'rz',   avatar:'', initials:'R' },
  { id:'u4', name:'JJ Supervisor',     title:'Shift Supervisor', pin:'3333', role:'staff', store:'jj',   avatar:'', initials:'S' },
  { id:'u5', name:'Runza Supervisor',  title:'Shift Supervisor', pin:'4444', role:'staff', store:'rz',   avatar:'', initials:'S' }
];


/* ════════════════════════════════════════════════════════════
   STORE NAMES
   Change these if your store names change.
   ════════════════════════════════════════════════════════════ */
const STORE_NAMES = {
  jj:   "Jimmy John's",
  rz:   'Runza',
  both: 'Both Stores'
};


/* ════════════════════════════════════════════════════════════
   SEED TASKS
   Demo tasks written to Firebase on the very first load.
   After first load these only exist in Firebase — editing
   them here won't change anything unless you clear Firebase.
   ════════════════════════════════════════════════════════════ */
const SEED_TASKS = [
  { id:'t1', title:'Count safe & deposit',      notes:'', date:'2026-02-20', stores:['jj'],       rec:'daily',  recDays:[],  recMonthType:'date', recOcc:1, recDay:1, color:'coral',    done:false },
  { id:'t2', title:'Complete line check',       notes:'', date:'2026-02-20', stores:['rz'],       rec:'daily',  recDays:[],  recMonthType:'date', recOcc:1, recDay:1, color:'mint',     done:false },
  { id:'t3', title:'JJ Staff meeting',          notes:'', date:'2026-02-21', stores:['jj'],       rec:'weekly', recDays:[5], recMonthType:'date', recOcc:1, recDay:5, color:'coral',    done:false },
  { id:'t4', title:'Order produce',             notes:'Check par levels', date:'2026-02-21', stores:['rz'], rec:'weekly', recDays:[1,4], recMonthType:'date', recOcc:1, recDay:1, color:'mint', done:false },
  { id:'t5', title:'All-hands safety training', notes:'', date:'2026-02-22', stores:['jj','rz'],  rec:'none',   recDays:[],  recMonthType:'date', recOcc:1, recDay:1, color:'lavender', done:false },
  { id:'t6', title:'Health inspection prep',    notes:'', date:'2026-02-25', stores:['rz'],       rec:'none',   recDays:[],  recMonthType:'date', recOcc:1, recDay:1, color:'yellow',   done:false }
];
const SEED_POP = [
  { id:'p1', title:'Call bread vendor', at:'8:32 AM', done:false },
  { id:'p2', title:'Fix fryer timer',   at:'9:15 AM', done:false }
];


/* ════════════════════════════════════════════════════════════
   COLOR MAP
   Maps color names (used in tasks) to actual hex values.
   ════════════════════════════════════════════════════════════ */
const COLOR_MAP = {
  coral:    '#FF6B6B',
  sky:      '#4D96FF',
  mint:     '#6BCB77',
  lavender: '#C77DFF',
  lav:      '#C77DFF',
  yellow:   '#FFD93D',
  peach:    '#FFB347'
};

const MONTHS   = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYNAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const COLOR_OPTIONS = ['coral','sky','mint','lavender','yellow','peach'];


/* ════════════════════════════════════════════════════════════
   APP STATE
   These variables hold everything the app knows right now.
   They get updated whenever Firebase sends new data.
   ════════════════════════════════════════════════════════════ */
let USERS        = [];   // all team members
let tasks        = [];   // all tasks from Firebase
let popTasks     = [];   // all pop tasks from Firebase
let appLogo      = '';   // base64 logo image

let currentUser  = null; // the person currently logged in
let activeStores = { jj: true, rz: true }; // admin store filter

// Calendar state
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth();
let selectedDate = null;

// Task form state
let editingTaskId    = null;  // null = new task, id = editing existing
let schedulingPopId  = null;  // set when turning a pop task into a real task
let selectedColor    = 'coral';
let selectedRec      = 'none';
let selectedWeekDays    = [];
let selectedBiWeekDays  = [];
let selectedMonthType   = 'date';
let selectedMonthOcc    = 1;
let selectedMonthDay    = 1;
let selectedTaskStores  = [];

// UI state
let completedOpen  = false;  // is the Completed section expanded?
let editingUserId  = null;   // which user is being edited
let editUserStore  = 'jj';   // workspace selection in edit user sheet

// Firebase listener cleanup functions
let unsubTasks = null, unsubPop = null, unsubUsers = null, unsubMeta = null;


/* ════════════════════════════════════════════════════════════
   DATE HELPERS
   Always uses today's real date (not hardcoded).
   ════════════════════════════════════════════════════════════ */
function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function offsetDay(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function pad2(n) { return String(n).padStart(2,'0'); }

// Formats "2026-02-20" → "Feb 20, 2026"
function formatDate(d) {
  if (!d) return '';
  const p  = d.split('-');
  const mn = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return mn[+p[1] - 1] + ' ' + (+p[2]) + ', ' + p[0];
}

// Returns current time as "9:32 AM"
function getTime() {
  const n = new Date(), h = n.getHours(), m = n.getMinutes(), ap = h >= 12 ? 'PM' : 'AM';
  return (h % 12 || 12) + ':' + pad2(m) + ' ' + ap;
}


/* ════════════════════════════════════════════════════════════
   SYNC STATUS DOT
   Updates the small colored dot in the top bar.
   ════════════════════════════════════════════════════════════ */
function setSyncStatus(status) {
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-status-lbl');
  if (!dot) return;
  dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'offline' ? ' offline' : '');
  if (lbl) lbl.textContent = status === 'syncing' ? 'Syncing…' : status === 'offline' ? 'Offline' : 'Connected';
}


/* ════════════════════════════════════════════════════════════
   FIREBASE READ/WRITE FUNCTIONS
   These talk to Firestore. Each function does one thing.
   ════════════════════════════════════════════════════════════ */

// Write (create or update) any document in any collection
async function fbSet(collectionName, id, data) {
  setSyncStatus('syncing');
  try {
    await setDoc(doc(db, collectionName, String(id)), data);
    setSyncStatus('ok');
  } catch (e) {
    setSyncStatus('offline');
    console.error('Firebase write error:', e);
  }
}

// Delete any document
async function fbDelete(collectionName, id) {
  setSyncStatus('syncing');
  try {
    await deleteDoc(doc(db, collectionName, String(id)));
    setSyncStatus('ok');
  } catch (e) {
    setSyncStatus('offline');
    console.error('Firebase delete error:', e);
  }
}


/* ════════════════════════════════════════════════════════════
   REAL-TIME LISTENERS
   These run after login. They watch Firebase for any changes
   and instantly update the app when something changes —
   even if a different device made the change.
   ════════════════════════════════════════════════════════════ */
function startListeners() {

  // Watch tasks collection
  unsubTasks = onSnapshot(collection(db, 'tasks'), snap => {
    tasks = [];
    snap.forEach(d => tasks.push(d.data()));
    tasks.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
    refreshActivePage();
    updateBadges();
    if (selectedDate) showDayPanel(selectedDate);
  });

  // Watch popTasks collection
  unsubPop = onSnapshot(collection(db, 'popTasks'), snap => {
    popTasks = [];
    snap.forEach(d => popTasks.push(d.data()));
    updateBadges();
    const pg = document.querySelector('.page.active');
    if (pg && pg.id === 'pg-pop') renderPop();
    renderCalendarPopList();
  });

  // Watch users collection
  unsubUsers = onSnapshot(collection(db, 'users'), snap => {
    if (snap.empty) return;
    USERS = [];
    snap.forEach(d => USERS.push(d.data()));
    // Keep currentUser data fresh
    if (currentUser) {
      const fresh = USERS.find(u => u.id === currentUser.id);
      if (fresh) currentUser = fresh;
    }
    buildLoginScreen();
    const pg = document.querySelector('.page.active');
    if (pg && pg.id === 'pg-settings') renderSettings();
  });

  // Watch meta collection (app logo, etc.)
  unsubMeta = onSnapshot(collection(db, 'meta'), snap => {
    snap.forEach(d => { if (d.id === 'appLogo') appLogo = d.data().value || ''; });
    updateTopAvatar();
    const ll = document.getElementById('login-logo');
    if (ll && appLogo) ll.innerHTML = '<img src="' + appLogo + '">';
  });
}

// Stop all listeners when logging out
function stopListeners() {
  [unsubTasks, unsubPop, unsubUsers, unsubMeta].forEach(u => { try { if (u) u(); } catch(e) {} });
  unsubTasks = unsubPop = unsubUsers = unsubMeta = null;
}


/* ════════════════════════════════════════════════════════════
   SEED DATA
   Writes default users and tasks to Firebase on the very
   first time the app is opened. Never runs again after that.
   ════════════════════════════════════════════════════════════ */
async function seedIfEmpty() {
  const snap = await getDocs(collection(db, 'users'));
  if (!snap.empty) return; // already seeded — skip

  const batch = writeBatch(db);
  DEFAULT_USERS.forEach(u => batch.set(doc(db, 'users', u.id), u));
  SEED_TASKS.forEach(t   => batch.set(doc(db, 'tasks', t.id), t));
  SEED_POP.forEach(p     => batch.set(doc(db, 'popTasks', p.id), p));
  await batch.commit();
  console.log('Planera: seed data written to Firebase.');
}


/* ════════════════════════════════════════════════════════════
   UTILITY HELPERS
   Small reusable functions used throughout the app.
   ════════════════════════════════════════════════════════════ */

// Escapes HTML special characters to prevent display bugs
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Shows the brief pop-up message at the bottom (e.g. "Task saved!")
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2200);
}

// Returns the "No tasks here" placeholder HTML
function emptyBox(emoji, text) {
  return '<div class="empty"><div class="empty-e">' + emoji + '</div><div class="empty-t">' + esc(text) + '</div></div>';
}

// Finds a task by ID
function findTask(id) { return tasks.find(t => String(t.id) === String(id)) || null; }

// Opens a bottom sheet overlay
function openSheet(id)  { document.getElementById(id).classList.add('open'); }
function closeSheet(id) { document.getElementById(id).classList.remove('open'); }

// Returns true if logged-in user is admin
function isAdmin() { return currentUser && currentUser.role === 'admin'; }

// Returns which stores the current user can see
function userStores() {
  if (!currentUser) return [];
  if (isAdmin()) return Object.keys(activeStores).filter(s => activeStores[s]);
  return currentUser.store === 'both' ? ['jj', 'rz'] : [currentUser.store];
}

// Returns true if a task should be visible to the current user
function taskVisible(t) {
  if (!t.stores) return false;
  return t.stores.some(s => userStores().includes(s));
}

// Returns only the tasks the current user is allowed to see
function visibleTasks() { return tasks.filter(taskVisible); }

// Returns the store badge HTML (JJ, RZ, or Both) for a task
function storeTagHTML(stores) {
  if (!isAdmin() && !(currentUser && currentUser.store === 'both')) return '';
  if (!stores || !stores.length) return '';
  if (stores.length >= 2) return '<span class="tboth-tag">Both</span>';
  return stores[0] === 'jj'
    ? '<span class="tstore-tag tstore-jj">JJ</span>'
    : '<span class="tstore-tag tstore-rz">RZ</span>';
}

// Returns the human-readable recurrence label for a task
function recLabel(t) {
  if (!t.rec || t.rec === 'none') return '';
  if (t.rec === 'daily')     return 'Every day';
  if (t.rec === 'yearly')    return 'Yearly';
  if (t.rec === 'weekly')    return t.recDays && t.recDays.length ? 'Weekly: '    + t.recDays.map(d => DAYNAMES[d]).join(', ') : 'Weekly';
  if (t.rec === 'biweekly')  return t.recDays && t.recDays.length ? 'Bi-weekly: ' + t.recDays.map(d => DAYNAMES[d]).join(', ') : 'Bi-weekly';
  if (t.rec === 'monthly') {
    if (t.recMonthType === 'weekday') {
      const occ = { '-1':'Last', '1':'1st', '2':'2nd', '3':'3rd', '4':'4th' };
      return 'Monthly: ' + (occ[String(t.recOcc)] || t.recOcc) + ' ' + DAYNAMES[t.recDay];
    }
    return 'Monthly';
  }
  return t.rec;
}

// Allows the notes toolbar buttons to work
function noteCmd(cmd) { document.getElementById('f-notes').focus(); document.execCommand(cmd, false, null); }
window.noteCmd = noteCmd;
window.triggerAvatarUpload = () => document.getElementById('avatar-upload').click();


/* ════════════════════════════════════════════════════════════
   TASK CARD HTML
   Builds the HTML for a single task card.
   Called whenever task lists need to be rendered.
   ════════════════════════════════════════════════════════════ */
function taskHTML(t) {
  const rl   = recLabel(t);
  const barC = COLOR_MAP[t.color] || (t.stores && t.stores[0] === 'jj' ? '#D4371C' : '#006341');
  let meta = '';
  if (t.date) meta += '<span class="tdt">' + formatDate(t.date) + '</span>';
  if (rl)     meta += '<span class="trec">&#8635; ' + esc(rl) + '</span>';
  meta += storeTagHTML(t.stores);

  return '<div class="tcard' + (t.done ? ' done' : '') + '" data-id="' + t.id + '">'
    + '<div class="tbar" style="background:' + barC + '"></div>'
    + '<div class="tchk-wrap chk-btn" data-id="' + t.id + '"><div class="tchk' + (t.done ? ' on' : '') + '">' + (t.done ? '✓' : '') + '</div></div>'
    + '<div class="tbody open-edit" data-id="' + t.id + '">'
      + '<div class="ttitle">' + esc(t.title) + '</div>'
      + (meta ? '<div class="tmeta">' + meta + '</div>' : '')
    + '</div>'
  + '</div>';
}


/* ════════════════════════════════════════════════════════════
   GLOBAL CLICK HANDLER
   Handles checkbox taps and task card taps (to open edit sheet).
   ════════════════════════════════════════════════════════════ */
document.addEventListener('click', e => {

  // Checkbox tap — toggle done/undone
  const chk = e.target.closest('.chk-btn');
  if (chk) {
    e.stopPropagation();
    const t = findTask(chk.dataset.id);
    if (t) {
      t.done = !t.done;
      fbSet('tasks', t.id, t);
      showToast(t.done ? 'Done! ✓' : 'Reopened');
    }
    return;
  }

  // Task body tap — open edit sheet
  const eb = e.target.closest('.open-edit');
  if (eb) { e.stopPropagation(); openEditTask(eb.dataset.id); return; }
});


/* ════════════════════════════════════════════════════════════
   NAVIGATION
   Handles switching between the 5 pages.
   ════════════════════════════════════════════════════════════ */
document.querySelectorAll('.btab').forEach(tab => {
  tab.addEventListener('click', () => goPage(tab.dataset.page));
});

function goPage(name) {
  // Hide all pages and deactivate all tabs
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.btab').forEach(t => t.classList.remove('on'));

  // Show the selected page and highlight its tab
  const page = document.getElementById('pg-' + name);
  const tab  = document.getElementById('tab-' + name);
  if (page) page.classList.add('active');
  if (tab)  tab.classList.add('on');

  // Render the correct content for that page
  if (name === 'today')    renderToday();
  if (name === 'calendar') renderCalendar();
  if (name === 'pop')      renderPop();
  if (name === 'list')     renderList();
  if (name === 'settings') { renderSettings(); page.scrollTop = 0; }
}

// Refreshes whichever page is currently showing
function refreshActivePage() {
  const pg = document.querySelector('.page.active');
  if (!pg) return;
  if (pg.id === 'pg-today')    renderToday();
  if (pg.id === 'pg-calendar') renderCalendar();
  if (pg.id === 'pg-list')     renderList();
}

// Updates the badge numbers on the Today and Pop tabs
function updateBadges() {
  const TODAY   = todayStr();
  const vt      = visibleTasks();
  const todayCt = vt.filter(t => !t.done && t.date && t.date <= TODAY).length;
  const popCt   = popTasks.filter(p => !p.done).length;

  const bT = document.getElementById('bdg-today');
  bT.textContent = todayCt;
  bT.classList.toggle('vis', todayCt > 0);

  const bP = document.getElementById('bdg-pop');
  bP.textContent = popCt;
  bP.classList.toggle('vis', popCt > 0);
}


/* ════════════════════════════════════════════════════════════
   STORE FILTER PILLS (admin only)
   The JJ / Runza pills in the top bar.
   ════════════════════════════════════════════════════════════ */
function renderStorePills() {
  const pills = document.getElementById('store-pills');
  if (!isAdmin()) { pills.style.display = 'none'; return; }
  pills.style.display = 'flex';
  pills.innerHTML =
    '<div class="spill' + (activeStores.jj ? ' on-jj' : '') + '" data-ws="jj">JJ</div>' +
    '<div class="spill' + (activeStores.rz ? ' on-rz' : '') + '" data-ws="rz">Runza</div>';
}

document.getElementById('store-pills').addEventListener('click', e => {
  const el = e.target.closest('.spill');
  if (!el) return;
  const ws     = el.dataset.ws;
  const active = Object.keys(activeStores).filter(k => activeStores[k]);
  // Prevent deselecting the last active store
  if (active.length === 1 && activeStores[ws]) { showToast('At least one store must be selected'); return; }
  activeStores[ws] = !activeStores[ws];
  renderStorePills();
  updateBadges();
  refreshActivePage();
  if (selectedDate) showDayPanel(selectedDate);
});


/* ════════════════════════════════════════════════════════════
   TODAY PAGE
   ════════════════════════════════════════════════════════════ */
function renderToday() {
  const TODAY = todayStr();
  const vt    = visibleTasks();

  // Split tasks into buckets
  const overdue   = vt.filter(t => !t.done && t.date && t.date < TODAY);
  const dueToday  = vt.filter(t => !t.done && t.date === TODAY);
  const completed = tasks.filter(t => t.done && taskVisible(t));

  // Store banner at top
  const bEl = document.getElementById('today-store-banner');
  if (isAdmin()) {
    const active = Object.keys(activeStores).filter(k => activeStores[k]);
    const cls    = active.length === 2 ? 'both' : active[0];
    const name   = active.length === 2 ? 'Both Stores' : STORE_NAMES[active[0]];
    bEl.innerHTML = '<div class="store-banner ' + cls + '"><div class="sb-text"><div class="sb-name">' + esc(name) + '</div><div class="sb-sub">&#9679; Live sync active</div></div></div>';
  } else {
    const st = currentUser.store;
    bEl.innerHTML = '<div class="store-banner ' + (st === 'both' ? 'both' : st) + '"><div class="sb-text"><div class="sb-name">' + esc(STORE_NAMES[st]) + '</div><div class="sb-sub">Your workspace</div></div></div>';
  }

  // Overdue section
  document.getElementById('ov-wrap').style.display = overdue.length ? 'block' : 'none';
  if (overdue.length) document.getElementById('ov-list').innerHTML = overdue.map(taskHTML).join('');

  // Due today
  document.getElementById('td-list').innerHTML = dueToday.length
    ? dueToday.map(taskHTML).join('')
    : emptyBox('☀️', "Nothing due today — you're all clear!");

  // Completed
  document.getElementById('dn-list').innerHTML = completed.length
    ? completed.map(taskHTML).join('')
    : emptyBox('', 'No completed tasks');

  updateBadges();
}

// Expand/collapse the Completed section
document.getElementById('dn-hdr').addEventListener('click', () => {
  completedOpen = !completedOpen;
  document.getElementById('dn-body').classList.toggle('open', completedOpen);
  document.getElementById('dn-arrow').classList.toggle('open', completedOpen);
});


/* ════════════════════════════════════════════════════════════
   LIST PAGE
   ════════════════════════════════════════════════════════════ */
function renderList() {
  const TODAY = todayStr();
  const TOM   = offsetDay(1);
  const DA    = offsetDay(2);
  const vt    = visibleTasks();

  // Define sections
  const sections = [
    { id:'ls-ov',  label:'Overdue',    icon:'🔴', open:true,  tasks: vt.filter(t => !t.done && t.date && t.date < TODAY) },
    { id:'ls-td',  label:'Today',      icon:'☀️',  open:true,  tasks: vt.filter(t => !t.done && t.date === TODAY) },
    { id:'ls-tom', label:'Tomorrow',   icon:'🎯', open:false, tasks: vt.filter(t => !t.done && t.date === TOM) },
    { id:'ls-da',  label:'Day After',  icon:'📅', open:false, tasks: vt.filter(t => !t.done && t.date === DA) },
    { id:'ls-up',  label:'Upcoming',   icon:'⏫', open:false, tasks: vt.filter(t => !t.done && t.date && t.date > DA) }
  ];

  document.getElementById('list-sections').innerHTML = sections.map(s =>
    '<div class="list-sec-hdr" data-sec="' + s.id + '">'
      + '<div class="list-sec-title"><span>' + s.icon + '</span> ' + esc(s.label) + ' <span class="list-sec-count">' + s.tasks.length + '</span></div>'
      + '<div class="list-sec-arrow' + (s.open ? ' open' : '') + '">&#9650;</div>'
    + '</div>'
    + '<div class="list-sec-body' + (s.open ? ' open' : '') + '" id="' + s.id + '">'
      + (s.tasks.length ? s.tasks.map(taskHTML).join('') : emptyBox('', 'No tasks here'))
    + '</div>'
  ).join('');
}

// Collapse/expand list sections
document.getElementById('list-sections').addEventListener('click', e => {
  const hdr = e.target.closest('.list-sec-hdr');
  if (hdr) {
    const body  = document.getElementById(hdr.dataset.sec);
    const arrow = hdr.querySelector('.list-sec-arrow');
    if (body && arrow) { body.classList.toggle('open'); arrow.classList.toggle('open'); }
  }
});


/* ════════════════════════════════════════════════════════════
   CALENDAR PAGE
   ════════════════════════════════════════════════════════════ */
document.getElementById('cal-prev').addEventListener('click', () => { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); });
document.getElementById('cal-next').addEventListener('click', () => { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); });

function renderCalendar() {
  const TODAY = todayStr();
  document.getElementById('cal-lbl').textContent = MONTHS[calMonth] + ' ' + calYear;

  const cells  = document.getElementById('cal-cells');
  cells.innerHTML = '';

  const vt     = visibleTasks();
  const dow    = new Date(calYear, calMonth, 1).getDay();     // day of week for 1st
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const daysInPrev  = new Date(calYear, calMonth, 0).getDate();
  const total  = Math.ceil((dow + daysInMonth) / 7) * 7;     // total cells needed

  for (let i = 0; i < total; i++) {
    let dayNum, isOtherMonth = false;

    if (i < dow) {
      dayNum = daysInPrev - dow + i + 1;
      isOtherMonth = true;
    } else if (i >= dow + daysInMonth) {
      dayNum = i - dow - daysInMonth + 1;
      isOtherMonth = true;
    } else {
      dayNum = i - dow + 1;
    }

    const dateStr   = isOtherMonth ? null : calYear + '-' + pad2(calMonth + 1) + '-' + pad2(dayNum);
    const dayTasks  = dateStr ? vt.filter(t => t.date === dateStr) : [];

    const cls = 'cal-cell'
      + (isOtherMonth      ? ' oth' : '')
      + (dateStr === TODAY  ? ' tod' : '')
      + (dateStr === selectedDate ? ' sel' : '');

    // Colored dots (up to 4) representing tasks on that day
    const dots = dayTasks.slice(0, 4).map(t => {
      const c = t.stores && t.stores.length >= 2 ? '#C77DFF' : (t.stores && t.stores[0] === 'jj' ? '#D4371C' : '#006341');
      return '<div class="cal-dot" style="background:' + c + '"></div>';
    }).join('');

    const cell = document.createElement('div');
    cell.className = cls;
    cell.innerHTML = '<div class="cal-dn">' + dayNum + '</div><div class="cal-dots">' + dots + '</div>'
      + (dayTasks.length > 4 ? '<div style="font-size:8px;color:var(--muted);font-weight:800">+' + (dayTasks.length - 4) + '</div>' : '');

    // Clicking a day selects it and shows its tasks below
    if (dateStr) {
      cell.addEventListener('click', (d => () => { selectedDate = d; renderCalendar(); showDayPanel(d); })(dateStr));
    }
    cells.appendChild(cell);
  }

  renderCalendarPopList();
  if (selectedDate) showDayPanel(selectedDate);
}

// Shows tasks for the selected day in the panel below the calendar
function showDayPanel(d) {
  document.getElementById('dpt').textContent = formatDate(d);
  const dayTasks = visibleTasks().filter(t => t.date === d);
  document.getElementById('dpt-tasks').innerHTML = dayTasks.length
    ? dayTasks.map(taskHTML).join('')
    : emptyBox('', 'No tasks on this day');
}

// Renders the unscheduled pop tasks at the bottom of the calendar
function renderCalendarPopList() {
  const list = popTasks.filter(p => !p.done);
  const el   = document.getElementById('cal-pop-list');
  if (!list.length) { el.innerHTML = '<div style="font-size:12px;color:var(--muted);font-weight:700">All pop tasks scheduled!</div>'; return; }
  el.innerHTML = list.map(p =>
    '<div class="pop-mini">'
      + '<span>⚡</span>'
      + '<span class="pop-mini-t">' + esc(p.title) + '</span>'
      + '<button class="asn-btn" data-pop-id="' + esc(p.id) + '">Schedule</button>'
    + '</div>'
  ).join('');
}
document.getElementById('cal-pop-list').addEventListener('click', e => {
  const btn = e.target.closest('.asn-btn');
  if (btn) openSchedulePop(btn.dataset.popId);
});


/* ════════════════════════════════════════════════════════════
   POP TASKS PAGE
   ════════════════════════════════════════════════════════════ */
function renderPop() {
  const active = popTasks.filter(p => !p.done);
  document.getElementById('pop-cnt').textContent = active.length ? '(' + active.length + ')' : '';

  if (!popTasks.length) {
    document.getElementById('pop-grid').innerHTML = emptyBox('⚡', 'Tap + to add a pop task!');
    return;
  }

  document.getElementById('pop-grid').innerHTML = popTasks.map((p, i) => {
    const colorName = COLOR_OPTIONS[i % COLOR_OPTIONS.length];
    return '<div class="pop-card" style="opacity:' + (p.done ? '0.55' : '1') + '">'
      + '<div class="pctop" style="background:' + (COLOR_MAP[colorName] || '#ccc') + '"></div>'
      + '<div class="pcbody">'
        + '<div class="pctitle">' + esc(p.title) + '</div>'
        + '<div class="pctime">Added ' + esc(p.at) + '</div>'
        + '<div class="pcacts">'
          + '<button class="pact pa-sched" data-action="schedule" data-pop-id="' + esc(p.id) + '">Schedule</button>'
          + '<button class="pact pa-done"  data-action="toggle"   data-pop-id="' + esc(p.id) + '">' + (p.done ? 'Undo' : 'Done') + '</button>'
          + '<button class="pact pa-del"   data-action="delete"   data-pop-id="' + esc(p.id) + '">Delete</button>'
        + '</div>'
      + '</div>'
    + '</div>';
  }).join('');
}

document.getElementById('pop-grid').addEventListener('click', e => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const { action, popId } = btn.dataset;
  if (action === 'schedule') openSchedulePop(popId);
  if (action === 'toggle')  { const p = popTasks.find(x => x.id === popId); if (p) { p.done = !p.done; fbSet('popTasks', p.id, p); } }
  if (action === 'delete')  fbDelete('popTasks', popId);
});

// Opens the full task sheet pre-filled with pop task title
function openSchedulePop(pid) {
  const p = popTasks.find(x => x.id === pid);
  if (!p) return;
  schedulingPopId = pid;
  editingTaskId   = null;
  resetTaskSheet();
  document.getElementById('sheet-title').textContent     = 'Schedule Pop Task';
  document.getElementById('btn-add-save').textContent    = 'Schedule';
  document.getElementById('btn-del-task').style.display  = 'none';
  document.getElementById('f-title').value               = p.title;
  document.getElementById('f-date').value                = selectedDate || todayStr();
  openSheet('ov-add');
}


/* ════════════════════════════════════════════════════════════
   FAB (+ button)
   Opens the pop add sheet on Pop page, task sheet everywhere else.
   ════════════════════════════════════════════════════════════ */
document.getElementById('btn-fab').addEventListener('click', () => {
  const pg = document.querySelector('.page.active');
  schedulingPopId = null;
  if (pg && pg.id === 'pg-pop') openPopAdd();
  else openAddTask();
});


/* ════════════════════════════════════════════════════════════
   POP QUICK-ADD SHEET
   ════════════════════════════════════════════════════════════ */
function openPopAdd() {
  document.getElementById('f-pop-title').value = '';
  openSheet('ov-pop-add');
  setTimeout(() => document.getElementById('f-pop-title').focus(), 320);
}
document.getElementById('btn-pop-cancel').addEventListener('click', () => closeSheet('ov-pop-add'));
document.getElementById('ov-pop-add').addEventListener('click',    e => { if (e.target === e.currentTarget) closeSheet('ov-pop-add'); });
document.getElementById('btn-pop-save').addEventListener('click',  () => {
  const val = document.getElementById('f-pop-title').value.trim();
  if (!val) { showToast('Enter a task'); return; }
  closeSheet('ov-pop-add');
  const id = 'p' + Date.now();
  fbSet('popTasks', id, { id, title: val, at: getTime(), done: false });
  showToast('Pop task added! ⚡');
});


/* ════════════════════════════════════════════════════════════
   ADD / EDIT TASK SHEET
   ════════════════════════════════════════════════════════════ */
document.getElementById('btn-add-cancel').addEventListener('click', () => { closeSheet('ov-add'); schedulingPopId = null; });
document.getElementById('ov-add').addEventListener('click', e => { if (e.target === e.currentTarget) { closeSheet('ov-add'); schedulingPopId = null; } });

// Shows/hides the recurrence sub-options panel
function showRecSub(type) {
  document.getElementById('rec-weekly-sub').classList.toggle('show',   type === 'weekly');
  document.getElementById('rec-biweekly-sub').classList.toggle('show', type === 'biweekly');
  document.getElementById('rec-monthly-sub').classList.toggle('show',  type === 'monthly');
}

// Updates workspace pill button colors to match selection
function updateStoreOptsUI() {
  document.querySelectorAll('#store-opts .oc').forEach(el => {
    el.className = 'oc' + (selectedTaskStores.includes(el.dataset.v) ? ' s-coral' : '');
  });
}

// Resets all task sheet fields to defaults
function resetTaskSheet() {
  selectedColor       = 'coral';
  selectedRec         = 'none';
  selectedWeekDays    = [];
  selectedBiWeekDays  = [];
  selectedMonthType   = 'date';
  selectedMonthOcc    = 1;
  selectedMonthDay    = 1;

  // Default workspace selection
  selectedTaskStores = isAdmin()
    ? (Object.keys(activeStores).filter(k => activeStores[k]).length === 1
        ? Object.keys(activeStores).filter(k => activeStores[k])
        : ['jj'])
    : (currentUser.store === 'both' ? ['jj'] : [currentUser.store]);

  // Clear all form fields
  document.getElementById('f-title').value      = '';
  document.getElementById('f-notes').innerHTML  = '';
  document.getElementById('f-date').value        = selectedDate || todayStr();

  // Reset option pills
  document.querySelectorAll('#rec-opts .oc').forEach((el, i) => el.className = 'oc' + (i === 0 ? ' s-none' : ''));
  document.querySelectorAll('#sw-opts .swatch').forEach(el => el.classList.toggle('sel', el.dataset.c === 'coral'));
  document.querySelectorAll('#weekly-days .day-btn, #biweekly-days .day-btn').forEach(b => b.classList.remove('on'));
  document.querySelectorAll('#monthly-type-opts .oc').forEach((el, i) => el.className = 'oc' + (i === 0 ? ' s-sky' : ''));
  document.querySelectorAll('#monthly-occ-opts .oc, #monthly-day-opts .day-btn').forEach(el => el.className = el.classList.contains('day-btn') ? 'day-btn' : 'oc');
  document.getElementById('monthly-weekday-sub').style.display = 'none';
  showRecSub('none');

  // Show/hide workspace picker for admin
  document.getElementById('f-store-wrap').style.display = isAdmin() ? 'block' : 'none';
  if (isAdmin()) updateStoreOptsUI();
}

// Opens the sheet to add a brand new task
function openAddTask() {
  editingTaskId = null;
  resetTaskSheet();
  document.getElementById('sheet-title').textContent    = 'New Task';
  document.getElementById('btn-add-save').textContent   = 'Save Task';
  document.getElementById('btn-del-task').style.display = 'none';
  openSheet('ov-add');
  setTimeout(() => document.getElementById('f-title').focus(), 320);
}

// Opens the sheet to edit an existing task
function openEditTask(rawId) {
  const t = findTask(rawId);
  if (!t) return;
  schedulingPopId = null;
  editingTaskId   = t.id;
  resetTaskSheet();

  document.getElementById('sheet-title').textContent    = 'Edit Task';
  document.getElementById('btn-add-save').textContent   = 'Save Changes';
  document.getElementById('btn-del-task').style.display = 'block';

  // Fill in existing values
  document.getElementById('f-title').value     = t.title;
  document.getElementById('f-notes').innerHTML = t.notes || '';
  document.getElementById('f-date').value       = t.date || '';

  // Color
  selectedColor = t.color || 'coral';
  document.querySelectorAll('#sw-opts .swatch').forEach(el => el.classList.toggle('sel', el.dataset.c === selectedColor));

  // Recurrence
  selectedRec = t.rec || 'none';
  document.querySelectorAll('#rec-opts .oc').forEach(el => {
    el.className = 'oc' + (el.dataset.v === selectedRec ? (selectedRec === 'none' ? ' s-none' : ' s-sky') : '');
  });
  showRecSub(selectedRec);

  if (t.recDays) {
    selectedWeekDays   = t.recDays.slice();
    selectedBiWeekDays = t.recDays.slice();
    document.querySelectorAll('#weekly-days .day-btn, #biweekly-days .day-btn').forEach(b => {
      b.classList.toggle('on', t.recDays.includes(parseInt(b.dataset.d)));
    });
  }

  selectedMonthType = t.recMonthType || 'date';
  selectedMonthOcc  = t.recOcc  || 1;
  selectedMonthDay  = t.recDay  || 1;
  document.querySelectorAll('#monthly-type-opts .oc').forEach(el => el.className = 'oc' + (el.dataset.v === selectedMonthType ? ' s-sky' : ''));
  if (selectedMonthType === 'weekday') {
    document.getElementById('monthly-weekday-sub').style.display = 'block';
    document.querySelectorAll('#monthly-occ-opts .oc').forEach(el => el.className = 'oc' + (parseInt(el.dataset.v) === selectedMonthOcc ? ' s-sky' : ''));
    document.querySelectorAll('#monthly-day-opts .day-btn').forEach(b => b.classList.toggle('on', parseInt(b.dataset.d) === selectedMonthDay));
  }

  // Workspace
  selectedTaskStores = (t.stores && t.stores.length) ? t.stores.slice() : ['jj'];
  if (isAdmin()) { document.getElementById('f-store-wrap').style.display = 'block'; updateStoreOptsUI(); }

  openSheet('ov-add');
}

/* — Form interaction handlers — */
document.getElementById('store-opts').addEventListener('click', e => {
  const el = e.target.closest('.oc'); if (!el) return;
  const v = el.dataset.v, idx = selectedTaskStores.indexOf(v);
  if (idx > -1) { if (selectedTaskStores.length === 1) { showToast('Select at least one workspace'); return; } selectedTaskStores.splice(idx, 1); }
  else selectedTaskStores.push(v);
  updateStoreOptsUI();
});

document.getElementById('rec-opts').addEventListener('click', e => {
  const el = e.target.closest('.oc'); if (!el) return;
  selectedRec = el.dataset.v;
  document.querySelectorAll('#rec-opts .oc').forEach(c => c.className = 'oc');
  el.className = 'oc ' + (selectedRec === 'none' ? 's-none' : 's-sky');
  showRecSub(selectedRec);
});

document.getElementById('weekly-days').addEventListener('click', e => {
  const b = e.target.closest('.day-btn'); if (!b) return;
  const d = parseInt(b.dataset.d), idx = selectedWeekDays.indexOf(d);
  if (idx > -1) selectedWeekDays.splice(idx, 1); else selectedWeekDays.push(d);
  b.classList.toggle('on', selectedWeekDays.includes(d));
});

document.getElementById('biweekly-days').addEventListener('click', e => {
  const b = e.target.closest('.day-btn'); if (!b) return;
  const d = parseInt(b.dataset.d), idx = selectedBiWeekDays.indexOf(d);
  if (idx > -1) selectedBiWeekDays.splice(idx, 1); else selectedBiWeekDays.push(d);
  b.classList.toggle('on', selectedBiWeekDays.includes(d));
});

document.getElementById('monthly-type-opts').addEventListener('click', e => {
  const el = e.target.closest('.oc'); if (!el) return;
  selectedMonthType = el.dataset.v;
  document.querySelectorAll('#monthly-type-opts .oc').forEach(c => c.className = 'oc');
  el.className = 'oc s-sky';
  document.getElementById('monthly-weekday-sub').style.display = selectedMonthType === 'weekday' ? 'block' : 'none';
});

document.getElementById('monthly-occ-opts').addEventListener('click', e => {
  const el = e.target.closest('.oc'); if (!el) return;
  selectedMonthOcc = parseInt(el.dataset.v);
  document.querySelectorAll('#monthly-occ-opts .oc').forEach(c => c.className = 'oc');
  el.className = 'oc s-sky';
});

document.getElementById('monthly-day-opts').addEventListener('click', e => {
  const b = e.target.closest('.day-btn'); if (!b) return;
  selectedMonthDay = parseInt(b.dataset.d);
  document.querySelectorAll('#monthly-day-opts .day-btn').forEach(c => c.classList.remove('on'));
  b.classList.add('on');
});

document.getElementById('sw-opts').addEventListener('click', e => {
  const el = e.target.closest('.swatch'); if (!el) return;
  selectedColor = el.dataset.c;
  document.querySelectorAll('#sw-opts .swatch').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
});

// Save button — handles new task, edited task, and scheduled pop task
document.getElementById('btn-add-save').addEventListener('click', () => {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { showToast('Enter a title first'); return; }
  if (isAdmin() && !selectedTaskStores.length) { showToast('Select at least one workspace'); return; }

  // Clean up notes HTML
  let notes = document.getElementById('f-notes').innerHTML;
  if (notes.replace(/<br\s*\/?>/gi,'').replace(/&nbsp;/gi,'').trim() === '') notes = '';

  const stores  = isAdmin() ? selectedTaskStores.slice() : (currentUser.store === 'both' ? ['jj','rz'] : [currentUser.store]);
  const recDays = selectedRec === 'weekly' ? selectedWeekDays.slice() : selectedRec === 'biweekly' ? selectedBiWeekDays.slice() : [];

  // The task data object to save
  const taskData = {
    title,
    notes,
    date:         document.getElementById('f-date').value || null,
    stores,
    rec:          selectedRec,
    recDays,
    recMonthType: selectedMonthType,
    recOcc:       selectedMonthOcc,
    recDay:       selectedMonthDay,
    color:        selectedColor
  };

  if (schedulingPopId) {
    // Convert a pop task into a real task
    const id = 't' + Date.now();
    fbSet('tasks', id, { id, done: false, ...taskData });
    fbDelete('popTasks', schedulingPopId);
    schedulingPopId = null;
    showToast('Scheduled! ✓');

  } else if (editingTaskId !== null) {
    // Update existing task
    const t = findTask(editingTaskId);
    if (t) { Object.assign(t, taskData); fbSet('tasks', t.id, t); }
    showToast('Updated! ✓');

  } else {
    // Create new task
    const id = 't' + Date.now();
    fbSet('tasks', id, { id, done: false, ...taskData });
    showToast('Task saved! ✓');
  }

  closeSheet('ov-add');
});

// Delete button
document.getElementById('btn-del-task').addEventListener('click', () => {
  if (editingTaskId === null) return;
  fbDelete('tasks', String(editingTaskId));
  closeSheet('ov-add');
  showToast('Deleted');
});


/* ════════════════════════════════════════════════════════════
   SETTINGS PAGE
   ════════════════════════════════════════════════════════════ */
function renderSettings() {
  if (!currentUser) return;

  // Profile section
  document.getElementById('settings-username').textContent = currentUser.name;
  document.getElementById('settings-role').textContent     = (currentUser.title || currentUser.role)
    + (currentUser.store !== 'both' ? ' — ' + STORE_NAMES[currentUser.store] : '');

  const av = document.getElementById('settings-av');
  av.innerHTML = currentUser.avatar ? '<img src="' + currentUser.avatar + '">' : currentUser.initials;

  document.getElementById('change-photo-btn').style.display = isAdmin() ? 'block' : 'none';

  // Show admin-only sections
  const isAd = isAdmin();
  document.getElementById('admin-workspaces-section').style.display = isAd ? 'block' : 'none';
  document.getElementById('admin-team-section').style.display       = isAd ? 'block' : 'none';
  document.getElementById('admin-danger-section').style.display     = isAd ? 'block' : 'none';

  if (isAd) renderTeamList();
}

// Builds the team member list under Settings
function renderTeamList() {
  const tl = document.getElementById('team-list');
  tl.innerHTML = USERS.map(u => {
    const tagBg   = u.store === 'jj' ? '#fff1ee' : u.store === 'rz' ? '#e8f5f0' : '#f5f0ff';
    const tagColor = u.store === 'jj' ? 'var(--jj)' : u.store === 'rz' ? 'var(--rz)' : 'var(--lav)';
    const avBg    = u.store === 'jj' ? '#D4371C' : u.store === 'rz' ? '#006341' : '#6C3EBF';
    const avHTML  = u.avatar ? '<img src="' + u.avatar + '">' : u.initials;
    return '<div class="user-row" data-uid="' + u.id + '">'
      + '<div class="user-av" style="background:' + avBg + '">' + avHTML + '</div>'
      + '<div class="user-info"><div class="user-name">' + esc(u.name) + '</div><div class="user-meta">' + esc(u.title || u.role) + ' &bull; PIN: ' + esc(u.pin) + '</div></div>'
      + '<span class="user-store-tag" style="background:' + tagBg + ';color:' + tagColor + '">' + esc(STORE_NAMES[u.store]) + '</span>'
      + '<span class="user-edit-hint">›</span>'
    + '</div>';
  }).join('');

  tl.querySelectorAll('.user-row').forEach(r => r.addEventListener('click', () => openEditUser(r.dataset.uid)));
}


/* ════════════════════════════════════════════════════════════
   EDIT TEAM MEMBER SHEET
   ════════════════════════════════════════════════════════════ */
function openEditUser(uid) {
  const u = USERS.find(x => x.id === uid);
  if (!u) return;
  editingUserId = uid;
  editUserStore = u.store || 'jj';
  document.getElementById('eu-name').value = u.name || '';
  document.getElementById('eu-role').value = u.title || '';
  document.getElementById('eu-pin').value  = u.pin || '';
  document.querySelectorAll('#eu-store-opts .oc').forEach(el => el.className = 'oc' + (el.dataset.v === editUserStore ? ' s-sky' : ''));
  openSheet('ov-edit-user');
}

document.getElementById('eu-store-opts').addEventListener('click', e => {
  const el = e.target.closest('.oc'); if (!el) return;
  editUserStore = el.dataset.v;
  document.querySelectorAll('#eu-store-opts .oc').forEach(c => c.className = 'oc');
  el.className = 'oc s-sky';
});
document.getElementById('btn-eu-cancel').addEventListener('click', () => closeSheet('ov-edit-user'));
document.getElementById('ov-edit-user').addEventListener('click', e => { if (e.target === e.currentTarget) closeSheet('ov-edit-user'); });

document.getElementById('btn-eu-save').addEventListener('click', () => {
  const u = USERS.find(x => x.id === editingUserId);
  if (!u) return;
  const pin  = document.getElementById('eu-pin').value.trim();
  const name = document.getElementById('eu-name').value.trim();
  if (!/^\d{4}$/.test(pin)) { showToast('PIN must be 4 digits'); return; }
  if (!name)                 { showToast('Enter a name'); return; }
  if (USERS.find(x => x.id !== editingUserId && x.pin === pin)) { showToast('That PIN is already taken'); return; }
  u.name     = name;
  u.title    = document.getElementById('eu-role').value.trim() || u.title;
  u.pin      = pin;
  u.store    = editUserStore;
  u.initials = name.charAt(0).toUpperCase();
  fbSet('users', u.id, u);
  closeSheet('ov-edit-user');
  showToast('Team member updated!');
});


/* ════════════════════════════════════════════════════════════
   AVATAR / LOGO UPLOAD
   ════════════════════════════════════════════════════════════ */
document.getElementById('avatar-upload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const data        = ev.target.result;
    appLogo           = data;
    currentUser.avatar = data;
    updateTopAvatar();
    fbSet('meta', 'appLogo', { value: data });
    fbSet('users', currentUser.id, currentUser);
    showToast('Photo updated!');
    renderSettings();
  };
  reader.readAsDataURL(file);
  e.target.value = '';
});

// Updates the small avatar in the top-left corner
function updateTopAvatar() {
  const av = document.getElementById('top-av');
  if (!av) return;
  if (currentUser && currentUser.avatar) av.innerHTML = '<img src="' + currentUser.avatar + '">';
  else if (appLogo)                      av.innerHTML = '<img src="' + appLogo + '">';
  else                                   av.textContent = currentUser ? currentUser.initials : 'P';
}


/* ════════════════════════════════════════════════════════════
   SHARE SHEET
   Lets admin send the app URL and GM PIN to team members.
   ════════════════════════════════════════════════════════════ */
document.getElementById('share-jj-row').addEventListener('click', () => openShare('jj'));
document.getElementById('share-rz-row').addEventListener('click', () => openShare('rz'));

function openShare(store) {
  document.getElementById('share-title').textContent    = 'Share — ' + STORE_NAMES[store];
  const gm = USERS.find(u => u.role === 'gm' && u.store === store);
  document.getElementById('share-pin-text').textContent = gm ? gm.pin : '—';
  document.getElementById('share-url-text').textContent = window.location.href;
  openSheet('ov-share');
}

function copyText(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => showToast('Copied!')).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;opacity:0';
  document.body.appendChild(ta);
  ta.focus(); ta.select();
  try { document.execCommand('copy'); showToast('Copied!'); } catch(e) { showToast(text); }
  document.body.removeChild(ta);
}

document.getElementById('share-copy-url-btn').addEventListener('click', () => copyText(document.getElementById('share-url-text').textContent));
document.getElementById('share-copy-pin-btn').addEventListener('click', () => copyText(document.getElementById('share-pin-text').textContent));
document.getElementById('btn-share-close').addEventListener('click',    () => closeSheet('ov-share'));
document.getElementById('ov-share').addEventListener('click', e => { if (e.target === e.currentTarget) closeSheet('ov-share'); });


/* ════════════════════════════════════════════════════════════
   TOGGLE SWITCHES & ACCENT COLOR
   ════════════════════════════════════════════════════════════ */
document.querySelectorAll('.toggle').forEach(t => t.addEventListener('click', () => t.classList.toggle('on')));

document.querySelectorAll('.accent-dot').forEach(dot => {
  dot.addEventListener('click', () => {
    document.querySelectorAll('.accent-dot').forEach(d => d.classList.remove('sel'));
    dot.classList.add('sel');
    document.documentElement.style.setProperty('--coral', dot.dataset.color);
    showToast('Accent color updated');
  });
});


/* ════════════════════════════════════════════════════════════
   CLEAR ALL TASKS (admin danger zone)
   ════════════════════════════════════════════════════════════ */
document.getElementById('clear-data-row').addEventListener('click', async () => {
  if (!isAdmin()) return;
  if (!confirm('Delete ALL tasks from Firebase? This cannot be undone.')) return;
  try {
    const batch = writeBatch(db);
    (await getDocs(collection(db, 'tasks'))).forEach(d     => batch.delete(d.ref));
    (await getDocs(collection(db, 'popTasks'))).forEach(d  => batch.delete(d.ref));
    await batch.commit();
    showToast('All tasks cleared');
  } catch(e) {
    showToast('Error: ' + e.message);
  }
});


/* ════════════════════════════════════════════════════════════
   SIGN OUT
   ════════════════════════════════════════════════════════════ */
document.getElementById('logout-row').addEventListener('click', () => {
  stopListeners();

  // Reset all state
  currentUser      = null;
  tasks            = [];
  popTasks         = [];
  USERS            = [];
  activeStores     = { jj: true, rz: true };
  selectedDate     = null;
  completedOpen    = false;
  editingTaskId    = null;
  schedulingPopId  = null;

  // Return to Today tab
  document.querySelectorAll('.btab').forEach(t => t.classList.remove('on'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-today').classList.add('on');
  document.getElementById('pg-today').classList.add('active');

  // Show login screen
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('login-screen').classList.add('visible');
  buildLoginScreen();
});


/* ════════════════════════════════════════════════════════════
   LOGIN
   ════════════════════════════════════════════════════════════ */
let loginSelectedUser = null;

// Builds the list of profile buttons on the login screen
function buildLoginScreen() {
  const ll = document.getElementById('login-logo');
  if (appLogo) ll.innerHTML = '<img src="' + appLogo + '">';
  else         ll.textContent = 'P';

  const lu = document.getElementById('login-users');
  lu.innerHTML = USERS.map(u => {
    const bg     = u.store === 'jj' ? '#D4371C' : u.store === 'rz' ? '#006341' : '#6C3EBF';
    const avHTML = u.avatar ? '<img src="' + u.avatar + '">' : u.initials;
    return '<div class="login-user-btn" data-uid="' + u.id + '">'
      + '<div class="lub-av" style="background:' + bg + '">' + avHTML + '</div>'
      + '<div class="lub-info"><div class="lub-name">' + esc(u.name) + '</div><div class="lub-role">' + esc(u.title || u.role) + ' &bull; ' + esc(STORE_NAMES[u.store]) + '</div></div>'
    + '</div>';
  }).join('');

  // Clear PIN field
  document.getElementById('login-pin').value   = '';
  document.getElementById('login-err').textContent = '';
  loginSelectedUser = null;

  // Tap a profile to select it
  lu.querySelectorAll('.login-user-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      lu.querySelectorAll('.login-user-btn').forEach(b => b.classList.remove('sel'));
      btn.classList.add('sel');
      loginSelectedUser = btn.dataset.uid;
      document.getElementById('login-pin').focus();
    });
  });
}

document.getElementById('login-btn').addEventListener('click', doLogin);
document.getElementById('login-pin').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

function doLogin() {
  const pin    = document.getElementById('login-pin').value.trim();
  const errEl  = document.getElementById('login-err');

  // Find matching user
  const user = loginSelectedUser
    ? USERS.find(u => u.id === loginSelectedUser && u.pin === pin)
    : USERS.find(u => u.pin === pin);

  if (!user) { errEl.textContent = 'Incorrect PIN — try again.'; return; }

  // Successful login
  errEl.textContent = '';
  currentUser = user;

  // Set which stores this user can see
  if (!isAdmin()) {
    activeStores = {
      jj: currentUser.store === 'jj'   || currentUser.store === 'both',
      rz: currentUser.store === 'rz'   || currentUser.store === 'both'
    };
  } else {
    activeStores = { jj: true, rz: true };
  }

  // Show the app
  document.getElementById('login-screen').classList.remove('visible');
  document.getElementById('main-app').style.display = 'flex';

  updateTopAvatar();
  renderStorePills();
  renderToday();
  updateBadges();
  renderSettings();
  startListeners(); // begin Firebase real-time sync
}


/* ════════════════════════════════════════════════════════════
   APP STARTUP
   This runs when the page first loads.
   ════════════════════════════════════════════════════════════ */
async function init() {
  try {
    document.getElementById('loading-sub').textContent = 'Connecting to Firebase...';

    // Write seed data if this is the first time the app is opened
    await seedIfEmpty();

    // Load users so the login screen can show profile buttons
    const snap = await getDocs(collection(db, 'users'));
    USERS = [];
    snap.forEach(d => USERS.push(d.data()));

    // Load app logo if one has been set
    try {
      const metaSnap = await getDocs(collection(db, 'meta'));
      metaSnap.forEach(d => { if (d.id === 'appLogo') appLogo = d.data().value || ''; });
    } catch(e) {}

    // Hide loading screen, show login
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('login-screen').classList.add('visible');
    buildLoginScreen();

  } catch(e) {
    // Something went wrong connecting to Firebase
    console.error('Startup error:', e);
    document.getElementById('loading-sub').textContent = 'Cannot connect. Check your network and refresh.';
    document.querySelector('.loading-spinner').style.display = 'none';
  }
}

// Start the app!
init();

</script>
</body>
</html>
